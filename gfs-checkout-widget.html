<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html" />
<link rel="import" href="../iron-list/iron-list.html" />
<link rel="import" href="../iron-collapse/iron-collapse.html" />
<link rel="import" href="../gfs-droppoint/gfs-droppoint.html" />
<link rel="import" href="../gfs-store/gfs-store.html" />
<link rel="import" href="../gfs-delivery-address/gfs-delivery-address.html" />
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html" />
<link rel="import" href="../paper-spinner/paper-spinner.html" />
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../magoo-price/magoo-price.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/maps-icons.html">
<link rel="import" href="../mp-calendar/mp-calendar.html">


<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMQhcXM06TZBHZ95LwJBRVGSV4CqUQMpI&libraries=places"></script>

<!--
    `gfs-checkout`
    A polymer widget to provides a rich user interface that interacts with the GFS Checkout
    service in order to provide a wide range of easily configured delivery options.

    @demo demo/index.html
-->


<dom-module id="gfs-checkout">
    <template>
        <style is="custom-style">
            :host {
                font-family: "Helvetica Neue", Verdana, Arial, sans-serif;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;

                --white: #fff;
                --grey: #797979;
                --mp-cld-header-color: #000;
                --mp-cld-header-bg: #fff;
            }

            h3 {
                margin: 0;
                font-family: "Helvetica Neue", Verdana, Arial, sans-serif;
                clear: left;
            }

            .toggle-title {
                width: 100%;
                cursor: pointer;
            }

            .hidden {
                display: none !important;
                z-index: 0;
            }

            .fl { float: left; }
            .fr { float: right; }
            .clear { clear: both;}

            input[type=radio] {
                margin: 0;
                vertical-align: middle;
                display: inline-block
            }



            #mapContainer, #mapStoreContainer {
                display: block;
                position: relative;
            }

            #gfsMapCanvas, #storeMapCanvas {
                height: 400px;
                top: 0;
                left: 0;
            }

            #gfsSidebar {
                display: block;
                width: 350px;
                overflow-y: auto;
                padding: 10px;
            }

            .locateme-wrap {
                z-index: 2;
                position: absolute;
                right: 85px;
                bottom: 16px;
            }

            #locateme {
                display: none;
            }

            #dropPointDetails, #storeDetails {
                position: absolute;
                z-index: 1;
            }

            #droppoint_overlay, #store_overlay {
                width: 240px;
                height: 400px;
                background: rgba(0, 0, 0, .8);
                position: absolute;
                top: 0;
                left: 0;
                border-right: 1px solid #b9b9b9;
                margin: auto;
                color: silver;
            }

                #droppoint_overlay_close, #store_overlay_close {
                    position: absolute;
                    top: 32px;
                    right: 32px;
                    margin-top: -28px;
                    margin-right: -20px;
                }

            #toggleDropPointsViewControls, .storeHeader, #toggleStoresViewControls {
                display: flex;
                margin: 0 0 20px;
                padding: 0 0 3px;
                border-bottom: 1px solid #ccc;
                box-shadow: 0 2px 0 0 rgba(255, 255, 255, .7);
            }

            .toggle-label {
                /*display: inline-block;*/
                font-size: 18px;
                margin-right: 0.4em;
                display: flex;
            }

            iron-icons.toggle {
                vertical-align: initial;
            }

            .fade-in {
                transition: opacity 400ms ease-in;
                z-index: 2;
            }

            .fade-out {
                opacity: 0;
                transition: opacity 400ms ease-in;
                z-index: 0 !important;
            }

            paper-toggle-button.gfs-toggle {
                display: inline-block;
                --paper-toggle-button-checked-bar-color: #909090;
                --paper-toggle-button-checked-button-color: #909090;
                --paper-toggle-button-checked-ink-color: #909090;
                --paper-toggle-button-unchecked-bar-color: #909090;
                --paper-toggle-button-unchecked-button-color: #909090;
                --paper-toggle-button-unchecked-ink-color: #909090;
            }

            paper-toggle-button.droppoint-selection {
                margin: 1px 0 2px;
                display: inline-block;
                --paper-toggle-button-checked-bar-color: #29a54f;
                --paper-toggle-button-checked-button-color: #29a54f;
                --paper-toggle-button-checked-ink-color: #29a54f;
                --paper-toggle-button-unchecked-bar-color: #909090;
                --paper-toggle-button-unchecked-button-color: #909090;
                --paper-toggle-button-unchecked-ink-color: #909090;
            }

            .toggle-droppoints-store {
                display: inline-block;
                font-size: 16px;
                margin: 0;
            }

            #droppoint_detail_link {
                margin: 10px 0 3px;
            }

            a.droppoint_info,
            a.droppoint_info:visited,
            a.droppoint_info:active,
            a.store_info,
            a.store_info:visited,
            a.store_info:active {
                text-decoration: none;
                color: #29a54f;
                font: bold 11px "Raleway", "Helvetica Neue", Verdana, Arial, sans-serif;
                border-bottom: 1px solid transparent;
                padding: 0 2px 2px;
                transition: all .3s ease-in-out;
            }

                a.droppoint_info:hover, a.store_info:hover {
                    border-bottom: 1px solid #29a54f;
                    cursor: pointer;
                }

            .highlight {
                color: var(--white) !important;
                background-color: #90dca7 !important;
            }



            .cardList {
                display: flex;
                flex-wrap: wrap;
                height: 730px;
                overflow-x: hidden;
                overflow-y: scroll;
            }

            div.dark .open-late {
                -webkit-filter: invert(1);
                filter: invert(1);
            }

            div#gfsMapCanvas .loading, #storeMapCanvas .loading {
                margin: auto;
                width: 100px;
                padding-top: 120px;
            }

            paper-spinner#map-spinner {
                width: 100px;
                height: 100px;
            }

            div.cardList .loading {
                margin: auto;
                width: 100px;
                padding-top: 50px;
            }

            paper-spinner#list-spinner {
                width: 100px;
                height: 100px;
            }

            #droppoint-delivery-options {
                margin: 20px 0 0;
            }

            #dropPointListContainer, #storeListContainer {
                padding: 2px 0;
                box-shadow: inset 0 -4px 7px -5px rgba(0, 0, 0, .7);
                position: relative;
                z-index: 10;
            }

                #dropPointListContainer label, #storeListContainer label {
                    margin: 20px 0 10px;
                    font-size: 20px;
                    border-bottom: 1px solid #ccc;
                }

            .dp-card-margin {
                margin: 0 20px 0 0;
            }

                .dp-card-margin:nth-child(2n+1) {
                    margin-right: 0;
                }

            h3.carrier-name {
                font-size: 20px;
                margin: 0;
            }

            ul.carrier-list {
                margin-bottom: 10px;
            }

                ul.carrier-list:last-child {
                    margin-bottom: 5px;
                }

            li.gfsStd label, li.delivery-place label {
                margin: 0 0 0 4px;
                vertical-align: 0;
                display: initial;
            }

            li.delivery-place label {
                margin-bottom: 0;
            }

            #calendarPanel {
                padding: 15px;
            }

            span.gfsmethodname {
                margin: 3px 0 0;
            }

            .delivery-option-wrap {
                margin: 0 0 20px;
            }

                .delivery-option-wrap:last-child {
                    margin-bottom: 0
                }

            .header {
                color: #000;
                font-size: 22px;
                margin: 0;
                padding: 25px 20px;
                line-height: 35px;
                background: white;
                border: 1px solid #000;
                cursor: pointer;
                position: relative;
            }

                .header span h3 {
                    font-size: 24px;
                    margin-bottom: 0;
                    padding: 0 0 0 5px;
                    text-shadow: 1px 1px 1px rgba(255, 255, 255, .8);
                    display: inline-block;
                    vertical-align: middle
                }

                div.header:last-child {
                    margin: 0;
                }

            i.arrow {
                position: absolute;
                transform: translate(-6px, 0);
                margin-top: 12px;
                right: 32px;
            }

                i.arrow::before, i.arrow::after,
                i.arrow.less::before, i.arrow.less::after {
                    content: "";
                    width: 1px;
                    height: 16px;
                    background-color: #9b9b9b;
                    position: absolute;
                    transition: all 0.25s ease-in-out;
                }

                i.arrow::before {
                    transform: translate(6px, 0) rotate(45deg)
                }

                i.arrow::after {
                    transform: translate(-6px, 0) rotate(-45deg)
                }

                i.arrow.less::before {
                    transform: translate(-6px, 0) rotate(45deg);
                }

                i.arrow.less::after {
                    transform: translate(6px, 0) rotate(-45deg);
                }

                i.arrow.less::before {
                    transform: translate(-6px, 0) rotate(45deg);
                }

                i.arrow.less::after {
                    transform: translate(6px, 0) rotate(-45deg);
                }

            #standardDeliveryPanel, #calendarPanel, #dropPointPanel, #storePanel {
                background: white;
                color: #000;
                margin: -2px 0 0 0;
                padding: 35px 25px 0;
                border-right: 1px solid #000;
                border-bottom: 5px solid #d11216;
                border-left: 1px solid #000;
                position: relative;
                z-index: 10;
            }

            input[type="radio"]#standardDeliveriesOption,
            input[type="radio"]#calendarDeliveriesOption,
            input[type="radio"]#dropPointDeliveriesOption,
            input[type="radio"]#storeDeliveriesOption {
                width: 100%;
                max-width: 100%;
                height: 100%;
                margin: 0;
                position: absolute;
                top: 0;
                right: 0;
                cursor: pointer;
                z-index: 1;
                opacity: 0;
            }

            .toggle-content, #calendar-delivery-options {
                margin: 0;
                border-top: 1px solid #000;
            }

            ul.separated {
                margin: 20px 0 0;
                padding: 0;
            }

                ul.separated span {
                    width: 100%;
                    padding: 25px 0;
                    position: relative;
                    cursor: pointer;
                }

                ul.separated li {
                    margin: 0 0 15px;
                    list-style-type: none;
                    border: 1px solid #000;
                }

                ul.separated input[type=radio] {
                    width: 100%;
                    max-width: 100%;
                    height: 100%;
                    margin: 0;
                    position: absolute;
                    top: 0;
                    right: 0;
                    cursor: pointer;
                    z-index: 1;
                    opacity: 0;
                }

                    ul.separated input[type=radio]:checked + label {
                        background: #e3e3e3;
                    }

                ul.separated li label {
                    width: 100%;
                    margin: 0;
                    padding: 25px 20px;
                    vertical-align: middle;
                    position: relative;
                    display: inline-block;
                    cursor: pointer;
                    transition: all .3s ease-in-out;
                }

                    ul.separated li label span {
                        font-weight: normal;
                    }

            /* calendar */
            #calendar-widget {
                width: 100%;
                border: none;
            }

                #calendar-widget ::content #header > div {
                    color: #000;
                    background: #fff;
                }

                #calendar-widget ::content #mpCalendar .mp-cld-main {
                    border: none;
                }

                #calendar-widget ::content #mpCalendar .mp-cld-label {
                    color: #fff;
                    background: #d11216;
                    border: 3px solid #fff;
                }

                #calendar-widget ::content #mpCalendar .mp-cld-day {
                    color: #000;
                    background: #f5f5f5;
                    border: 3px solid #fff;
                }

                    #calendar-widget ::content #mpCalendar .mp-cld-day.today {
                        color: #fff;
                        background: #9d9c9c;
                    }

                    #calendar-widget ::content #mpCalendar .mp-cld-day.highlighted {
                        color: #000;
                        background: #9d9c9c;
                        transition: all .3s ease-in-out
                    }

                        #calendar-widget ::content #mpCalendar .mp-cld-day:hover::before {
                            background: none;
                        }

                        #calendar-widget ::content #mpCalendar .mp-cld-day.highlighted.selected {
                            color: #000;
                            background: #e3e3e3;
                            box-shadow: inset 0 -5px 0 0 #d11216;
                            transition: all .3s ease-in-out
                        }

            .calendar-info {
                margin: 25px 0;
            }

                .available-service, .unavailable-service, .selected-service {
                    margin: 0 10px 15px 30px;
                    display: inline-block;
                    position: relative;
                }

                    .available-service::before, .unavailable-service::before, .selected-service::before {
                        content: '';
                        width: 20px;
                        height: 20px;
                        background: #9d9c9c;
                        position: absolute;
                        top: 0;
                        left: -30px;
                    }

                .unavailable-service {

                }

                    .unavailable-service::before {
                        background: #f5f5f5;
                    }

                    .selected-service {

                    }

                        .selected-service::before {
                            background: #e3e3e3;
                            box-shadow: inset 0 -5px 0 0 #d11216;
                        }

            #calendar-delivery-options h4, #droppoint-delivery-options h4 {
                margin: 30px 0;
            }

            .droppoints-wrap, .stores-wrap {
                background: #f5f5f5;
                border: 1px solid #000;
                margin: 15px 0;
                padding: 10px;
            }

            .droppoint-margin {
                margin-right: 10px;
                position: relative;
            }

            .droppoint-margin:nth-child(2n+1) {
                margin-right: 0;
            }

            .store-margin {
                margin-right: 0;
                position: relative;
            }

                .store-margin:nth-child(2n+1) {
                    margin-right:20px;;
                }

            #gfsMapCanvas, #storeMapCanvas {
                margin: 0;
                position: relative;
            }

            paper-spinner#standard-spinner {
                width: 100px;
                height: 100px;
                margin-top: 20px;
                margin-left: -50px;
                position: relative;
                left: 50%;
            }

            paper-spinner#calendar-spinner {
                width: 100px;
                height: 100px;
                margin-top: 20px;
                margin-left: -50px;
                position: relative;
                left: 50%;
            }

            paper-spinner#search-spinner {
                width: 100px;
                height: 100px;
                margin-top: -50px;
                margin-left: -50px;
                top: 50%;
                left: 50%;
            }

            .search-postcode-wrap {
                margin: 10px 0;
                width: 100%;
            }

                .search-postcode-wrap .input-search {
                    width: 50%;
                }

            #droppointAddress.form-control {
                display: inline-block;
                width: 203px;
                color: #797979;
                margin: 0 5px 0 0;
                float: left;
            }

            #droppointSubmit {
                color: #797979;
            }

                #droppointSubmit:hover {
                    color: #797979;
                    background-color: #e6e6e6;
                    border-color: #adadad;
                    text-decoration: none;
                }

            #lastddPostcode, #lastStorePostcode {
                color: #29a54f;
                font-size: 12px;
                margin: 5px 0 0;
                display: block;
            }

            #go-to-home-droppoint, #go-to-home-store {
                margin: 0;
                position: absolute;
                right: 9px;
                bottom: 20px;
                z-index: 1;
                cursor: pointer;
            }


            #wrongPostoce {
                color: #d60000;
            }

            #errorNotification {
                --paper-toast-background-color: red;
                --paper-toast-color: white;
            }

            .info_box_img img {
                width: 29px !important;
                height: 29px !important;
            }

            span.price {
                color: #29a54f;
                font-weight: bold;
            }

            :host ::content #infobox-droppoint .dp-icon {
                padding-left: 0;
            }

            :host ::content #store_info {
                padding: 10px 0;
            }

            :host ::content #ddList .dp-icon,
            :host ::content #storeList .dp-icon {
                padding-left: 0;
            }

            .gfs-input {
                font-size: 14px;
                background-color: #fff;
                background-image: none;
                border: 1px solid #ccc;
                color: #797979;
                width: 203px;
                height: 34px;
                margin: 0 5px 0 0;
                padding: 6px 12px;
                line-height: 1.42857143;
                display: inline-block;
                float: left;
                border-radius: 4px;
                box-shadow: inset 0 1px 1px rgba(0,0,0,0.075);
                -webkit-transition: border-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
                -o-transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
                transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            }

            .gfs-btn {
                background-color: #fff;
                background-image: none;
                border: 1px solid #ccc;
                margin-bottom: 0;
                font-weight: normal;
                text-align: center;
                vertical-align: middle;
                font-size: 14px;
                line-height: 1.42857143;
                padding: 6px 12px;
                cursor: pointer;
                white-space: nowrap;
                display: inline-block;
                border-radius: 4px;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                transition: all .4s ease-in-out;
            }

            .gfs-lcc {
                margin: 0 10px 25px;
            }

            @media (max-width: 1024px) {
                .cardList {
                    margin: 0 auto;
                }

                #locateme {
                    width: 63px;
                }

                #go-to-home-address {
                    width: 50px;
                    height: 50px;
                    right: 70px;
                    bottom: 23px;
                }

                    #go-to-home-address img {
                        margin: 5px 0 0 -5px
                    }
            }

            @media (max-width: 768px) {
                #standardDeliveryPanel, #calendarPanel,
                #dropPointPanel, #storePanel {
                    padding: 35px 10px 0
                }

                .cardList {
                    width: 100%;
                    height: 380px;
                    overflow-x: scroll;
                    overflow-y: hidden;
                    flex-direction: column;
                    display: -webkit-flex;
                    -webkit-box-align: center;
                    -webkit-box-direction: normal;
                    -webkit-box-orient: horizontal;
                    -webkit-flex-direction: column;
                    -webkit-flex-wrap: wrap;
                    -webkit-overflow-scrolling: touch;
                }

                    .droppoint-margin.gfs-checkout:nth-child(2n+1).gfs-checkout {
                        margin-right: 10px;
                    }
            }

            @media (max-width: 667px) {
                .header span h3 {
                    font-size: 20px;
                    max-width: 200px;
                }

                #calendar-widget ::content #mpCalendar .mp-cld-day {
                    border: 2px solid #fff;
                }

                #droppoint_overlay {
                    height: 400px;
                }

                .userDroppointStores {
                    width: 100%;
                    margin: 10px 0 0;
                    float: left;
                }

                .search-postcode-wrap .input-search {
                    width: 100%;
                }

            }

            @media (max-width: 493px) {
                .header label {
                    font-size: 21px;
                }

                .droppoint-margin:nth-child(2n+1) {
                    margin-right: 20px;
                }

                #locateme {
                    width: 53px;
                    right: 10px;
                    bottom: 20px;
                    display: block;
                }
            }

            @media (max-width: 475px) {
                .header label {
                    font-size: 19px;
                }

                .droppoint-margin {
                    margin-right: 20px;
                }

                    .droppoint-margin:first-child {
                        margin-right: 0;
                    }
            }

            @media (max-width: 440px) {

                .header label {
                    font-size: 16px;
                }
            }

            @media (max-width: 414px) {
                .header label {
                    max-width: 90%;
                    vertical-align: middle;
                }

                ul {
                    list-style-type: none;
                }

                    ul li input[type="radio"] {
                        display: inline-block;
                        vertical-align: middle
                    }

                    ul li label {
                        font-size: 13px;
                        font-weight: normal;
                        vertical-align: middle;
                        display: inline-block;
                    }

                .cardList {
                    height: 350px;
                }

                #droppointAddress.form-control {
                    width: 189px;
                }
            }

            @media (max-width: 375px) {
                ul.separated li {
                    font-size: 12px;
                }
            }
        </style>

        <iron-ajax id="ajaxPost"
                   method="POST"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handlePostResponse"
                   on-error="_handleError">
        </iron-ajax>

        <iron-ajax id="ajaxPostPostcode"
                   method="POST"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handlePostPostcodeResponse">
        </iron-ajax>

        <iron-ajax id="ajaxGet"
                   method="GET"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handleGetResponse"
                   on-error="_handleError"
                   timeout="10000">
        </iron-ajax>

        <iron-ajax id="ajaxGetPostcode"
                   method="GET"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handleGetPostcodeResponse"
                   on-error="_handleError"
                   timeout="10000">
        </iron-ajax>

        <iron-ajax id="ajaxPatch"
                   method="PATCH"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handlePatchResponse">
        </iron-ajax>

        <iron-ajax id="ajaxGetDroppoints"
                   method="GET"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handleGetDroppointsResponse">
        </iron-ajax>


        <div id="widgetContainer">

            <!--Standard-->
            <div class="delivery-option-wrap">
                <div class="header" on-click="_toggleStandardDeliveryPanelCollapse">
                    <input name="deliveryTypePanel" id="standardDeliveriesOption" type="radio" value="{{defaultDelivery}}" />
                    <span class="standardDeliveriesOption">
                        <h3>{{standardDeliveryTitle}}</h3>
                    </span>
                    <i class="arrow"></i>
                </div>

                <iron-collapse id="standardDeliveryPanel">
                    <div class="toggle-content">
                        <div id="standard-loading" class="loading"><paper-spinner active id="standard-spinner"></paper-spinner></div>
                        <div class="services">
                            <ul class="separated">
                                <template is="dom-repeat" items="{{standardRates}}" sort="sortServices">
                                    <span>
                                        <li class="gfsStd">
                                            <input name="shipping_method" type="radio" on-click="updateDeliveryOptions" checked="{{item.selected}}" value="{{item.id}}" id="{{item.id}}" class="radio standard-delivery-selection" />
                                            <label for$="{{item.id}}">
                                                {{item.methodTitle}} <magoo-price currency-symbol="{{currencySymbol}}" price="{{item.price}}"></magoo-price> - <span>{{item.deliveryDateRange}}</span>
                                            </label>
                                        </li>
                                    </span>
                                </template>
                            </ul>

                            <div class="gfs-lcc lcc-charge hidden">The prices shown <strong>include</strong> import Duties and Taxes of {{currencySymbol}}{{taxAndDutyPrice}}</div>
                            <div class="gfs-lcc lcc-estimate hidden">
                                The prices shown <strong>exclude</strong> import Duties and Taxes. You may be charged an additional
                                {{currencySymbol}}{{taxAndDutyPrice}} by your local customs office
                            </div>
                        </div>
                    </div>
                </iron-collapse>
            </div>

            <!--Calendar-->
            <div class="delivery-option-wrap">
                <div class="header" on-click="_toggleCalendarPanelCollapse">
                    <input name="deliveryTypePanel" id="calendarDeliveriesOption" type="radio" value="{{defaultDelivery}}" />
                    <span class="calendarDeliveriesOption">
                        <h3>{{calendarDeliveryTitle}}</h3>
                    </span>
                    <i class="arrow"></i>
                </div>

                <iron-collapse id="calendarPanel">
                    <template is="dom-if" if="{{useCalendar}}">
                        <div id="calendar-loading" class="loading">
                            <paper-spinner active id="calendar-spinner"></paper-spinner>
                        </div>

                        <div class="toggle-content">
                            <mp-calendar id="calendar-widget" class="gfs-checkout hidden"
                                         month-labels='[[monthLabels]]'
                                         day-labels='[[dayLabels]]'
                                         disabled-days="[[disabledDays]]"
                                         disabled-dates="[[disabledDates]]"
                                         disable-prev-days="[[disableNextDays]]"
                                         disable-next-days="[[disablePrevDays]]">
                            </mp-calendar>

                            <div class="calendar-info">
                                <span class="available-service">Available</span>
                                <span class="unavailable-service">Unavailable</span>
                                <span class="selected-service">Selected</span>
                            </div>
                            <div id="calendar-delivery-options" class="hidden">
                                <h4>{{calendarDayPrompt}}</h4>
                                <div class="services">
                                    <ul class="separated">
                                        <template is="dom-repeat" items="{{_selectedDayDeliveries}}" sort="sortDayDefiniteServices">
                                            <span>
                                                <li class="delivery-place">
                                                    <input type="radio" name="shipping_method" value="{{item.id}}" id="{{item.id}}" checked="{{item.selected}}" on-click="updateDeliveryOptions" class="radio calendar-delivery-selection" />
                                                    <label for$="{{item.id}}">
                                                        {{item.methodTitle}} <magoo-price currency-symbol="{{currencySymbol}}" price="{{item.price}}"></magoo-price>
                                                    </label>
                                                </li>
                                            </span>
                                        </template>
                                    </ul>

                                    <div class="gfs-lcc lcc-charge hidden">The prices shown <strong>include</strong> import Duties and Taxes of {{currencySymbol}}{{taxAndDutyPrice}}</div>
                                    <div class="gfs-lcc lcc-estimate hidden">
                                        The prices shown <strong>exclude</strong> import Duties and Taxes. You may be charged an additional
                                        {{currencySymbol}}{{taxAndDutyPrice}} by your local customs office
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </iron-collapse>
            </div>

            <!--DropPoints-->
            <div class="delivery-option-wrap">
                <div class="header" on-click="_toggleDropPointPanelCollapse">
                    <input name="deliveryTypePanel" id="dropPointDeliveriesOption" type="radio" value="{{defaultDelivery}}" />
                    <span class="dropPointDeliveriesOption">
                        <h3>{{dropPointDeliveryTitle}}</h3>
                    </span>
                    <i class="arrow"></i>
                </div>

                <iron-collapse id="dropPointPanel" opened="{{_droppointOpened}}">
                    <div class="toggle-content">
                        <div class="droppoints-wrap">
                            <div id="toggleDropPointsViewControls">
                                <div class="toggle-label"><iron-icon icon="view-list" class="toggle"></iron-icon> List</div>
                                <paper-toggle-button id="toggleDropPointsView" class="gfs-toggle" on-change="_showDropPointsView" active="true" checked></paper-toggle-button>
                                <div class="toggle-label"><iron-icon icon="maps:place" class="toggle"></iron-icon> Map</div>
                            </div>

                            <div class="gfsDropPoint" id="mapContainer">
                                <div class="search-postcode-wrap">
                                    <div class="input-search fl">
                                        <input type="text" id="droppointAddress" class="gfs-input" placeholder="Find alternative postcode" />
                                        <button name="findPostcode" id="droppointSubmit" class="gfs-btn" on-click="_findPostcode">Find</button>
                                        <input type="hidden" id="homePostcodeDroppoint" value="" />
                                        <span id="lastddPostcode"></span>
                                    </div>

                                    <!-- options to show/hide droppoints or stores in the map -->
                                    <template is="dom-if" if="{{useDroppointsStores}}">
                                        <div class="userDroppointStores fr">
                                            <div style="width: 100%; display: flex;">
                                                <paper-toggle-button id="toggleStoreOnMap" class="droppoint-selection" on-change="_showStores" active="true"></paper-toggle-button>
                                                <div class="toggle-droppoints-store"> <iron-icon icon="maps:store-mall-directory"></iron-icon>Show Stores </div>
                                            </div>
                                            <div style="width: 100%; display: flex;">
                                                <paper-toggle-button id="toggleDropPointsOnMap" class="droppoint-selection" on-change="_hideDropPoints" active="true"></paper-toggle-button>
                                                <div class="toggle-droppoints-store"><iron-icon icon="maps:pin-drop"></iron-icon>Hide DropPoints </div>
                                            </div>
                                        </div>
                                    </template>

                                    <div class="clear"></div>
                                    <div id="go-to-home-droppoint" class="go-home-icon" on-click="_goToHome">
                                        <img src="//gfswidgetcdn.azurewebsites.net/images/widgets/goto-home.png" isHome="true" width="55" />
                                    </div>
                                    <div id="wrongPostoce"></div>
                                </div>

                                <div id="dropPointDetails" class$="{{_dropPointDetailsClass}}">
                                    <div id="droppoint_overlay" style="height: {{mapHeight}}px; display: block">
                                        <div id="droppoint_overlay_close" on-click="_hideDropPointDetails">
                                            <img src="//gfswidgetcdn.azurewebsites.net/images/widgets/x.png" alt="close" />
                                        </div>
                                        <gfs-droppoint id="overlay-droppoint" droppoint-data="{{_selectedDropPoint}}" container-class="overlay" show-distance="false" show-opening-hours="true"></gfs-droppoint>
                                    </div>
                                </div>
                                <div id="storeDetails" class$="{{_storeDetailsClass}}">
                                    <div id="store_overlay" style="height: {{mapHeight}}px; display: block">
                                        <div id="store_overlay_close" on-click="_hideStoreDetails">
                                            <img src="//gfswidgetcdn.azurewebsites.net/images/widgets/x.png" alt="close store" />
                                        </div>
                                        <gfs-store id="overlay-store" store-data="{{_selectedStore}}" map-icon="{{storeMapIcon}}" container-class="overlay" show-distance="false" show-opening-hours="true"></gfs-store>
                                    </div>
                                </div>
                                <div class="hidden">
                                    <div id="droppoint_info" on-click="_showDropPointDetails">
                                        <gfs-droppoint id="infobox-droppoint" droppoint-data="{{_selectedDropPoint}}" button-type="tick"></gfs-droppoint>
                                        <div id="droppoint_detail_link">
                                            <a class="droppoint_info"> View Opening Times </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="locateme-wrap">
                                    <img id='locateme' on-click="_locateMe" src='//gfswidgetcdn.azurewebsites.net/images/widgets/locateme.png' />
                                </div>

                                <div id="gfsMapCanvas">
                                    <div class="loading">
                                        <paper-spinner active id="map-spinner"></paper-spinner>
                                    </div>
                                </div>
                            </div>

                            <array-selector id="dropPointSelector" items="{{_dropPoints}}" selected="{{chosen}}" multi="false"></array-selector>
                            <div id="dropPointListContainer" class="hidden">
                                <h4>
                                    Drop Points
                                    <template is="dom-if" if="{{showStoreList}}">
                                        / Stores
                                    </template>
                                </h4>
                                <div class="cardList">
                                    <div id="list-loading" class="loading">
                                        <paper-spinner active id="list-spinner"></paper-spinner>
                                    </div>
                                    <template is="dom-if" if="{{_showDropPointList}}" restamp="true">
                                        <template id="dropPointList" is="dom-repeat" items="{{_dropPoints}}" sort="sortByDistance">
                                            <gfs-droppoint id="ddList" show-opening-hours="true" container-class="dp-card" button-type="standard" droppoint-data="{{item}}" class="droppoint-margin"></gfs-droppoint>
                                        </template>
                                    </template>

                                    <template is="dom-if" if="{{_showStoreList}}" restamp="true">
                                        <template id="storeList" is="dom-repeat" items="{{_stores}}" sort="sortByDistance">
                                            <gfs-store id="storeList" show-opening-hours="true" container-class="dp-card" button-type="standard" store-data="{{item}}" class="droppoint-margin"></gfs-store>
                                        </template>
                                    </template>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div id="droppoint-delivery-options">
                                <h4>{{dropPointDeliveryPrompt}}</h4>
                                <div class="services">
                                    <ul class="separated">
                                        <template is="dom-repeat" items="{{_selectedDroppoints}}" sort="sortServices">
                                            <span>
                                                <li class="delivery-place">
                                                    <input type="radio" name="shipping_method" value="{{item.id}}" id="{{item.id}}" checked="{{item.selected}}" on-click="updateDeliveryOptions" class="radio calendar-delivery-selection" />
                                                    <label for$="{{item.id}}">
                                                        {{item.methodTitle}} <magoo-price currency-symbol="{{currencySymbol}}" price="{{item.price}}"></magoo-price>
                                                    </label>
                                                </li>
                                            </span>
                                        </template>
                                    </ul>

                                    <div class="gfs-lcc lcc-charge hidden">The prices shown <strong>include</strong> import Duties and Taxes of {{currencySymbol}}{{taxAndDutyPrice}}</div>
                                    <div class="gfs-lcc lcc-estimate hidden">
                                        The prices shown <strong>exclude</strong> import Duties and Taxes. You may be charged an additional
                                        {{currencySymbol}}{{taxAndDutyPrice}} by your local customs office
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </iron-collapse>
            </div>

            <!--Stores-->
            <div class="delivery-option-wrap">
                <div class="header" on-click="_toggleStorePanelCollapse">
                    <input name="deliveryTypePanel" id="storeDeliveriesOption" type="radio" value="{{defaultDelivery}}" />
                    <span class="storeDeliveriesOption">
                        <h3>{{storeDeliveryTitle}}</h3>
                    </span>
                    <i class="arrow"></i>
                </div>

                <iron-collapse id="storePanel" opened="{{_storeOpened}}">
                    <div class="toggle-content">
                        <div class="stores-wrap">
                            <div id="toggleStoresViewControls">
                                <div class="toggle-label"><iron-icon icon="view-list" class="toggle"></iron-icon> List</div>
                                <paper-toggle-button id="toggleStoresView" class="gfs-toggle" on-change="_showStoresView" active="true" checked></paper-toggle-button>
                                <div class="toggle-label"><iron-icon icon="maps:place" class="toggle"></iron-icon> Map</div>
                            </div>

                            <div class="gfsStore" id="mapStoreContainer">
                                <div class="search-postcode-wrap">
                                    <input type="text" id="storeAddress" class="gfs-input" placeholder="Find alternative postcode" />
                                    <button name="findStorePostcode" id="storeSubmit" class="gfs-btn" on-click="_findPostcode">Find</button>
                                    <input type="hidden" id="homePostcodeStore" value="" />
                                    <span id="lastStorePostcode"></span>

                                    <div id="go-to-home-store" on-click="_goToHome">
                                        <img src="//gfswidgetcdn.azurewebsites.net/images/widgets/goto-home.png" isHome="true" width="55" />
                                    </div>
                                    <div id="wrongPostoce"></div>
                                </div>

                                <div id="storeDetails" class$="{{_storeDetailsClass}}">
                                    <div id="store_overlay" style="height: {{mapHeight}}px; display: block">
                                        <div id="store_overlay_close" on-click="_hideStoreDetails">
                                            <img src="//gfswidgetcdn.azurewebsites.net/images/widgets/x.png" alt="close store" />
                                        </div>
                                        <gfs-store id="overlay-store" store-data="{{_selectedStore}}" map-icon="{{storeMapIcon}}" container-class="overlay" show-distance="false" show-opening-hours="true"></gfs-store>
                                    </div>
                                </div>
                                <div class="hidden">
                                    <div id="store_info" on-click="_showStoreDetails">
                                        <gfs-store id="infobox-store" store-data="{{_selectedStore}}" button-type="tick"></gfs-store>
                                        <div id="store_detail_link">
                                            <a class="store_info"> View Opening Times </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="locateme-wrap">
                                    <img id='locateme' on-click="_locateMe" src="//gfswidgetcdn.azurewebsites.net/images/widgets/locateme.png" />
                                </div>

                                <div id="storeMapCanvas">
                                    <div class="loading">
                                        <paper-spinner active id="map-spinner"></paper-spinner>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <array-selector id="storeSelector" items="{{_stores}}" selected="{{chosen}}" multi="false"></array-selector>
                        <div id="storeListContainer" class="hidden">
                            <h4>Stores</h4>
                            <div class="cardList">
                                <div id="storeList-loading" class="loading">
                                    <paper-spinner active id="list-spinner"></paper-spinner>
                                </div>

                                <template is="dom-if" if="{{_showStoreList}}">
                                    <template id="storeList" is="dom-repeat" items="{{_stores}}" sort="sortByDistance">
                                        <gfs-store id="storeList" show-opening-hours="true" container-class="dp-card" button-type="standard" store-data="{{item}}" class="droppoint-margin"></gfs-store>
                                    </template>
                                </template>
                            </div>
                        </div>

                        <div>
                            <div id="store-delivery-options">
                                <h4>{{storeDeliveryPrompt}}</h4>
                                <div class="services">
                                    <ul class="separated">
                                        <template is="dom-repeat" items="{{_selectedStores}}" sort="sortServices">
                                            <span>
                                                <li class="delivery-place">
                                                    <input type="radio" name="shipping_method" value="{{item.id}}" id="{{item.id}}" checked="{{item.selected}}" on-click="updateDeliveryOptions" class="radio calendar-delivery-selection" />
                                                    <label for$="{{item.id}}">
                                                        {{item.methodTitle}} <magoo-price currency-symbol="{{currencySymbol}}" price="{{item.price}}"></magoo-price>
                                                    </label>
                                                </li>
                                            </span>
                                        </template>
                                    </ul>

                                    <div class="gfs-lcc lcc-charge hidden">The prices shown <strong>include</strong> import Duties and Taxes of {{currencySymbol}}{{taxAndDutyPrice}}</div>
                                    <div class="gfs-lcc lcc-estimate hidden">
                                        The prices shown <strong>exclude</strong> import Duties and Taxes. You may be charged an additional
                                        {{currencySymbol}}{{taxAndDutyPrice}} by your local customs office
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </iron-collapse>
            </div>
        </div>

        <input type="text" value="{{_selectedDropPoint.droppointId}}" id="dropPointRadio" class="hidden" />
        <input type="text" value="{{_selectedStore.droppointId}}" id="storeRadio" class="hidden" />

        <paper-toast id="errorNotification" class="fit-bottom"></paper-toast>
    </template>

    <script>
        var DAY_MS = 1000 * 60 * 60 * 24;
        var DOW_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun', '?'];
        var MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var geocoder = null;
        var marker = null;
        var storeMarker = null;
        var dropPointsStoreMarker = null;
        var previousPosition = [];
        var markers = [];
        var storeMarkers = [];

        Polymer({
            is: "gfs-checkout",

            properties: {
                accessToken: {
                    type: String
                },

                currencySymbol: {
                    type: String,
                    value: '$'
                },

                gfsData: {
                    type: String
                },

                useDropPoints: {
                    type: Object,
                    value: true
                },

                useStandard: {
                    type: Object,
                    value: true
                },

                useCalendar: {
                    type: Object,
                    value: true
                },

                useStores: {
                    type: Boolean,
                    value: false
                },

                useDroppointsStores: {
                    type: Boolean,
                    value: false
                },

                allowCalendarPreselect: {
                    type: Object,
                    value: true
                },

                initialAddress: {
                    type: String
                },

                // ATTRIBUTES
                //
                // These properties represent text used for labels, titles and prompts throughout the widget.
                // They are controlled by passing values via the element attributes.
                // To override the default values shown below, simply pass through the attributes name, with camel caps converted to dashed lower case:
                // e.g: 'dropPointTitle' would be set by:
                // <gfs-checkout drop-point-title="Your text goes here"></gfs-checkout>
                dropPointDeliveryTitle: {
                    type: String,
                    value: 'Collect your order'
                },

                dropPointDeliveryPrompt: {
                    type: String,
                    value: 'Select your preferred collection point to view available services:'
                },

                calendarDeliveryTitle: {
                    type: String,
                    value: 'Choose a delivery date and time'
                },

                storeDeliveryTitle: {
                    type: String,
                    value: 'Store location'
                },

                calendarDayPrompt: {
                    type: String,
                    value: 'Please select a delivery time:'
                },

                standardDeliveryTitle: {
                    type: String,
                    value: 'Standard delivery'
                },

                storeDeliveryPrompt: {
                    type: String,
                    value: 'Select your preferred collection point to view available services:'
                },

                // Change the value of the default-delivery where the <gfs-checkout> element is loaded: default-delivery="your_option_here"
                // set default delivery option => Standard, Express, CollectionPoint, Stores
                defaultDelivery: {
                    type: String,
                    value: 'Standard'
                },

                hideMapUI: {
                    type: Object,
                    value: false
                },

                mapHeight: {
                    type: Number,
                    value: 400
                },

                homeIcon: {
                    type: String
                },

                startingZoomLevel: {
                    type: Number,
                    value: 14
                },

                //cheapestFirst, fastestFirst, expensiveFirst, slowestFirst
                serviceSortOrder: {
                    type: String,
                    value: "cheapestFirst"
                },

                // set default service parameters when API is not available
                showBackupService: {
                    type: Boolean,
                    value: false
                },

                defaultService: {
                    type: String,
                    value: ""
                },

                defaultCarrier: {
                    type: String,
                    value: ""
                },

                defaultPrice: {
                    type: Number,
                    value: 0
                },

                defaultMinDeliveryTime: {
                    type: String,
                    value: ""
                },

                defaultMaxDeliveryTime: {
                    type: String,
                    value: ""
                },

                defaultCarrierCode: {
                    type: String,
                    value: ""
                },

                // make selected marker bouncing
                markerAmimation: {
                    type: Boolean,
                    value: false
                },

                selectedServiceDetails: {
                    type: Object,
                    value: {
                        service: null,
                        shipping: null,
                        deliveryAddress: null,
                        expDeliveryDateStart: null,
                        expDeliveryDateEnd: null,
                        collectPoint: null,
                        serviceType: null,
                        selectedDeliveryOptionID: null,
                        selectedDropopintId: null,
                        sessionId: null
                    }
                },

                closeCheckout: {
                    type: Object,
                    value: {
                        closeSession: true,
                        selectedDeliveryOptionID: null,
                        selectedDroppointId: null,
                        isStore: false
                    }
                },

                closeCheckoutData: {
                    type: Object,
                    value: {
                        checkoutSelectedServiceName: null,
                        checkoutSelectedPrice: null,
                        checkoutSelectedDroppointAddress: null

                    }
                },

                // keep the data for closeCheckout
                checkoutResults: {
                    type: String,
                    value: null
                },

                sessionid: {
                    type: String,
                    value: null
                },

                checkoutData: {
                    type: String,
                    value: null
                },

                // custom store icon on the map. Must set the full path of the image or a url
                storeMapIcon: {
                    type: String
                },

                showCalendarNoServices: {
                    type: Boolean,
                    value: false
                },

                calendarNoServices: {
                    type: String,
                    value: "There are no services available on this day "
                },

                /**
                * This property can be used to localize the elements month labels.
                */
                monthLabels: {
                    type: Array,
                    value: function () {
                        return ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    }
                },

                /**
                * This property can be used to localize the elements day labels. Do not change the order
                */
                dayLabels: {
                    type: Array,
                    value: function () {
                        return ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
                    }
                },

                /**
                * Disable previous month days
                */
                disablePrevDays: {
                    type: Object,
                    value: false
                },

                /**
                * Disable next month days
                */
                disableNextDays: {
                    type: Object,
                    value: false
                },

                /**
                * Disable week days. Set the disabled dates.
                * ex. disabled-dates="[4, 10, 12, 19, 30]".
                */
                disabledDates: {
                    type: Array,
                    value: []
                },

                /**
                * Disable week days. Set the disabled days. If you use custom dayLabels use the same values here.
                * ex. disabled-days='["Monday", "Thursday"]'.
                */
                disabledDays: {
                    type: Object,
                    value: function () {
                        return [];
                    }
                },

                /**
                *  Display or not the LCC message
                */
                showDutyMessage: {
                    type: Object,
                    value: true
                },

                /**
                *  LCC property to define if estimate or charge
                */
                taxAndDutyType: {
                    type: String,
                    value: "estimate",
                    observer: "taxAndDutyTypeChanged"
                },

                /**
                *  LCC value
                */
                taxAndDuty: {
                    type: Number,
                    value: 0,
                    observer: "taxAndDutyValueChanged"
                },

                // PRIVATE PROPERTIES
                //
                // Do not modify these properties.
                _endPoint: {
                    type: String,
                    readOnly: true,
                    value: "//rest-checkout.justshoutgfs.com/api/CheckoutSession/"
                },

                _droppointOpened: {
                    type: Boolean,
                    value: false
                },

                _selectedDropPoint: {
                    type: Object
                },

                _dropPointDetailsClass: {
                    type: String,
                    value: "hidden"
                },

                _storeOpened: {
                    type: Boolean,
                    value: false
                },

                _selectedStore: {
                    type: Object
                },

                _storeDetailsClass: {
                    type: String,
                    value: "hidden"
                },

                _shippingRateGroups: {
                    type: Array,
                    notify: true,
                    value: []
                },

                _data: {
                    type: Object,
                    value: {
                        dayDefinite: [],
                        droppoints: [],
                        standardRates: [],
                        links: [],
                        nonDayDefinite: [],
                        stores: []
                    }
                },

                _dropPoints: {
                    type: Array,
                    notify: true
                },

                _stores: {
                    type: Array,
                    notify: true
                },

                _map: {
                    type: Object
                },

                _storeMap: {
                    type: Object
                },

                _currentMarker: {
                    type: Object
                },

                _infoWindow: {
                    type: Object
                },

                _storeInfoWindow: {
                    type: Object
                },

                //Lookup for deliveries on a given day
                _deliveryDays: {
                    type: Object,
                    value: {}
                },

                //Lookup for deliveries on a given day
                _deliveryDroppoints: {
                    type: Object,
                    value: {}
                },

                _storesDelivery: {
                    type: Object,
                    value: {}
                },

                _earliestDelivery: {
                    type: Object,
                    value: null
                },

                _infoBoxDroppoint: {
                    type: Object
                },

                _showDropPointList: {
                    type: Boolean,
                    value: true
                },

                _showStoreList: {
                    type: Boolean,
                    value: false
                }
            },

            listeners: {
                "dateSelected": "_deliveryDateSelected",
                "prevMonth": "_calendarMonthChanged",
                "currMonth": "_calendarMonthChanged",
                "nextMonth": "_calendarMonthChanged",
                "droppoint-changed": "_droppointChanged",
                "store-changed": "_storeChanged"
            },

            observers: [
                'droppointOpenChanged(_droppointOpened)',
                'queryServer(accessToken, gfsData)',
                'storeOpenChanged(_storeOpened)'
            ],

            // Observer - if the token or data changes we need to re-query the server
            queryServer: function (token, data) {
                 var theJson = atob(data);
                 theJson = theJson.replace(/\r?\n|\r/g, "");
                 actualPost = JSON.parse(theJson);

                console.log("gfsData ", this.gfsData);

                // keep original home postcode
                this.$.homePostcodeDroppoint.value = actualPost.Request.Order.Transit.Recipient.Location.Postcode;
                this.$.homePostcodeStore.value = actualPost.Request.Order.Transit.Recipient.Location.Postcode;
                this.$$(".search-postcode-wrap").classList.add('hidden');
                this.$$("#calendarDeliveriesOption").parentNode.classList.remove("hidden");
                this.$$("#dropPointDeliveriesOption").parentNode.classList.remove("hidden");

                if (token === "") {
                    this.$.errorNotification.text = "No Access Token.. ";
                    this.$.errorNotification.duration = 8000;
                    this.$.errorNotification.show();
                }
                else {
                    this.$.ajaxPost.url = this._endPoint;

                    if (typeof actualPost.Request.Session == "undefined") {
                        actualPost.Request.Session = {}
                    }

                    this.$.ajaxPost.body = actualPost;
                    this.$.ajaxPost.headers = this._computeHeader();
                    this.$.ajaxPost.generateRequest();

                    if (this.defaultDelivery === '') { // set Standard delivery if none is supplied
                        this.defaultDelivery = 'Standard';
                    }

                    if (!this.useStores) {
                        this.$$("#storeDeliveriesOption").parentNode.classList.add("hidden");
                    }

                    // check which is the default delivery option
                    switch (this.defaultDelivery) {
                        case 'Standard':
                            return this.$.standardDeliveryPanel.opened = true, this.$.standardDeliveriesOption.checked = "checked", this.$.standardDeliveryPanel.parentElement.querySelector(".arrow").classList.add("less");
                        case 'Express':
                            return this.$.calendarPanel.opened = true, this.$.calendarDeliveriesOption.checked = "checked", this.$.calendarPanel.parentElement.querySelector(".arrow").classList.add("less");
                        case 'CollectionPoint':
                            return this.$.dropPointPanel.opened = true, this.$.dropPointDeliveriesOption.checked = "checked", this.$.dropPointPanel.parentElement.querySelector(".arrow").classList.add("less");
                        case 'Stores':
                            return this.$.storePanel.opened = true, this.$.storeDeliveriesOption.checked = "checked", this.$.storePanel.parentElement.querySelector(".arrow").classList.add("less");
                    }
                }
            },

            droppointOpenChanged: function (_droppointOpened) {
                if (this._selectedDropPoint) {
                    this.set('_selectedDropPoint.chosen', _droppointOpened);
                    this.fire("droppoint-changed", this._selectedDropPoint);
                }
            },

            _computeHeader: function() {
                return {
                    "Authorization": "Bearer " + atob(this.accessToken)
                };
            },

            // This function is called as soon as the widget is ready
            ready: function () {
                if (!window.moment) {
                    var moment = document.createElement('script');
                    moment.setAttribute('src', 'https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js');
                    document.body.appendChild(moment);
                }
            },

            attached: function () {
                if (this.useStores && this.useDroppointsStores) {
                    this.$.errorNotification.text = "Please select one store implementation";
                    this.$.errorNotification.duration = 8000;
                    this.$.errorNotification.show();
                }
            },

            // Handlers
            _handlePostResponse: function(e) {
                console.log("Followup GET", moment(new Date()).format("HH:mm:ss:SS"));
                this._sessionId = e.detail.response.substring(e.detail.response.lastIndexOf("/") + 1);
                this.$.ajaxGet.url = this._endPoint + this._sessionId;
                this.$.ajaxGet.headers = this._computeHeader();

                console.log('sessionID', this._sessionId);
                this.$.ajaxGet.generateRequest();
            },

            // search for a new post code and keep the sessionID
            _handlePostPostcodeResponse: function (e) {
                this.$.ajaxGetPostcode.url = this._endPoint + this._sessionId;
                this.$.ajaxGetPostcode.headers = this._computeHeader();
                this.$.ajaxGetPostcode.generateRequest();
            },

            _handleGetResponse: function(e) {
                this.$$('#list-spinner').active = false;
                this.$$('#list-loading').classList.add('hidden');
                this.$$('#storeList-loading').classList.add('hidden');
                this.$$('#standard-loading').classList.add('hidden');
                this.$$('.services').classList.remove('hidden');

                if (this.useCalendar) {
                    this.$$('mp-calendar').classList.remove('hidden');
                    this.$$('#calendar-loading').classList.add('hidden');
                    this.$$('#calendar-delivery-options').classList.remove('hidden');
                };

                this.$$(".search-postcode-wrap").classList.add('hidden');

                if (this.$$("#map-spinner")) {
                    this.$$("#map-spinner").classList.add('hidden');
                }

                this.countryCode = actualPost.Request.Order.Transit.Recipient.Location.CountryCode.Code;
                this.postCode = actualPost.Request.Order.Transit.Recipient.Location.Postcode;

                var useWebService = true; //false;

                if (useWebService) {
                    this._data = e.detail.response;
                }
                else if (typeof (this.gfsData) === "string") {
                    var unencoded = atob(this.gfsData);
                    this._data = JSON.parse(unencoded);
                }
                // load droppoints
                this._dropPoints = this._data.droppoints;
                this._stores = this._data.stores;

                window.setTimeout(this._delayedInit.bind(this), 0);
            },

            // return the new droppoints
            _handleGetPostcodeResponse: function (e) {
                this.countryCode = actualPost.Request.Order.Transit.Recipient.Location.CountryCode.Code;
                this.postCode = actualPost.Request.Order.Transit.Recipient.Location.Postcode;

                var newDroppoints = e.detail.response.droppoints;
                var newStores = e.detail.response.stores;

                this._dropPoints = this._removeDuplicateDropPoints(this._dropPoints.concat(newDroppoints));

                if (this.useDroppointsStores) {
                    this._stores = this._removeDuplicateDropPoints(this._stores.concat(newStores));
                }

                this._loadDroppointMarkers(this._dropPoints);
                this._findAllDeliveryDroppoints();
            },

            _handleError: function(e) {
                // hide all services except standard
                this.$$("#calendarDeliveriesOption").parentNode.classList.add("hidden");
                this.$$("#dropPointDeliveriesOption").parentNode.classList.add("hidden");
                this.$$("#storeDeliveriesOption").parentNode.classList.add("hidden");

                this.$$('#standard-loading').classList.add('hidden');
                this.$.standardDeliveriesOption.checked = "checked";
                this.defaultDelivery = "Standard";
                this.$.standardDeliveryPanel.opened = true;
                this.$.calendarPanel.opened = false;
                this.$.dropPointPanel.opened = false;
                this.$.storePanel.opened = false;
                this._noServices();
            },

            _handlePatchResponse: function (e) {
                // close no matter what, can't hold the order up because of api issues
                this.fire("close-checkout-complete", e.detail.response);
            },

            _handleGetDroppointsResponse: function(e) {
                // assign the new data.
                this._data = e.detail.response;
                if (!this._dropPoints)
                    this._dropPoints = [];

                this._dropPoints = this._dropPoints.concat(this._data.droppoints);
                this._findAllDeliveryDroppoints();
                this._loadDroppointMarkers(this._data.droppoints);
            },

            _delayedInit: function() {
                console.log("_delayedInit start ", moment(new Date()).format("HH:mm:ss:SS"));
                var elem = this;

                this._processInputData();

                if (this.useDropPoints) {
                    if (this.defaultDelivery === 'CollectionPoint') {
                        this.$$(".search-postcode-wrap").classList.remove('hidden');
                        this.$$("#droppoint-delivery-options").classList.remove('hidden');
                    }
                    this._makeMap('gfsMapCanvas', 'droppoint_info');
                    window.setTimeout(function() {
                        elem._loadDroppointMarkers(elem._dropPoints)
                    }, 0);
                    // sort droppoint data
                    this._findAllDeliveryDroppoints();
                }

                if (this.useCalendar)
                    this._makeCalendar();

                if (this.useStores) {
                    this._makeMap('storeMapCanvas', 'store_info');
                    this._loadStoreMarkers(this._data.stores, this._storeMap);
                    this._findAllDeliveryDroppoints();
                }

                this._checkForServices(this.defaultDelivery);

                // LCC
                this.lccNotification();
                console.log("_delayedInit end ", moment(new Date()).format("HH:mm:ss:SS"));
            },

            // sorting
            sortByDistance: function (a, b) {
                if (a === b) return 0;
                return a.distanceInMeters < b.distanceInMeters ? -1 : 1;
            },

            sortServices: function (a, b) {
                if (a == b) return 0;

                switch (this.serviceSortOrder) {
                    case "cheapestFirst":
                        return a.price < b.price ? -1 : 1;
                    case "fastestFirst":
                        return a.deliveryTimeFrom < b.deliveryTimeFrom ? -1 : 1;
                    case "expensiveFirst":
                        return a.price > b.price ? -1 : 1;
                    case "slowestFirst":
                        return a.deliveryTimeFrom > b.deliveryTimeFrom ? -1 : 1;
                    default:
                        return;
                }
            },

            sortDayDefiniteServices: function (a, b) {
                if (a == b) return 0;

                switch (this.serviceSortOrder) {
                    case "expensiveFirst":
                        return a.price > b.price ? -1 : 1;
                    case "cheapestFirst":
                    case "fastestFirst":
                    case "slowestFirst":
                    default:
                        return a.price < b.price ? -1 : 1;
                }
            },

            _processInputData: function () {
                this._processNonDayDefiniteData();
                // this._processStoreData();
            },

            _checkForServices: function (defaultDelivery) {
                if ((defaultDelivery === 'Standard') && (this._data.standardRates.length !== 0)) {
                    if (this.useStandard === false) {
                        this.$.standardDeliveryPanel.opened = false;
                        this.$$("#standardDeliveriesOption").parentNode.classList.add("hidden");

                        defaultDelivery = 'Express';
                    }
                    else {
                        this.$.standardDeliveriesOption.checked = "checked";
                        this.$.standardDeliveryPanel.opened = true;
                        this._preselectForStandard();
                    }
                }
                else if (this._data.standardRates.length === 0 || !this.useStandard) {
                    this.$.standardDeliveryPanel.opened = false;
                    this.$$("#standardDeliveriesOption").parentNode.classList.add("hidden");
                }

                if (((defaultDelivery === 'Express') || (this._data.standardRates.length === 0)) && (this._data.dayDefinite.length !== 0)) {
                    if (!this.useCalendar) {
                        this.$.calendarPanel.opened = false;
                        this.$$("#calendarDeliveriesOption").parentNode.classList.add("hidden");

                        defaultDelivery = 'CollectionPoint';
                    }
                    else {
                        this.$.calendarDeliveriesOption.checked = "checked";
                        this.$.calendarPanel.opened = true;
                        this._preselectForExpress();
                    }
                }
                else if ((this._data.dayDefinite.length === 0) || !this.useCalendar)  {
                    this.$.calendarPanel.opened = false;
                    this.$$("#calendarDeliveriesOption").parentNode.classList.add("hidden");
                }

                var deliveryDroppointsSize = this._data.droppoints.length;
                if ((defaultDelivery === 'CollectionPoint') && (deliveryDroppointsSize !== 0)) {
                    if (!this.useDropPoints) {
                        this.$.dropPointPanel.opened = false;
                        this.$$("#dropPointDeliveriesOption").parentNode.classList.add("hidden");

                        defaultDelivery = 'Stores';
                    }
                    else {
                        this.$.dropPointDeliveriesOption.checked = "checked";
                        this.$.dropPointPanel.opened = true;
                    }
                }
                else if (deliveryDroppointsSize === 0 || this._data.droppoints.length === 0 || !this.useDropPoints) {
                    this.$$("#dropPointDeliveriesOption").parentNode.classList.add("hidden");
                }

                var deliveryStoreSize = Object.keys(this._storesDelivery).length;
                if ((defaultDelivery === 'Stores') && (deliveryStoreSize !== 0)) {
                    this.$.storeDeliveriesOption.checked = "checked";
                    this.$.storePanel.opened = true;
                }
                else if (deliveryStoreSize === 0 || !this.useStores) {
                    this.$$("#storeDeliveriesOption").parentNode.classList.add("hidden");
                }

                // if we don't have services set a default one
                if ((this._data.standardRates.length === 0) && (this._data.dayDefinite.length === 0) && (deliveryDroppointsSize === 0) && (deliveryStoreSize === 0)) {
                    this.$$("#standardDeliveriesOption").parentNode.classList.remove("hidden");
                    this.$.standardDeliveriesOption.checked = "checked";
                    this.$.standardDeliveryPanel.opened = true;
                    this.$.errorNotification.text = "No services configured"
                    this.$.errorNotification.duration = 8000;
                    this.$.errorNotification.open();

                    if (this.showBackupService) {
                        this._noServices();
                    }
                    
                }
            },

            // find the earliest of each service
            _getGroupedByService: function() {
                var self = this;
                var results = [];
                var services = [];

                // find the earliest of each non day definite service
                this._data.nonDayDefinite.forEach(function(day) {
                    day.rates.forEach(function(service) {
                        if (service.serviceType.type === "dmStandard") {
                            if (self.taxAndDutyType.toLowerCase() === "charge" && self.taxAndDuty > 0) {
                                var gfsData = JSON.parse(atob(self.gfsData));
                                var countryCode = gfsData.Request.Order.Transit.Recipient.Location.CountryCode.Code;

                                if (countryCode !== "GB") {
                                    service.price = service.price + self.taxAndDuty;
                                }
                            }

                            if (typeof(services[service.methodTitle]) === "undefined") {
                                services[service.methodTitle] = {
                                    deliveryDate: day.deliveryDate,
                                    service: service
                                };
                            } else {
                                var servicesDay = new Date(services[service.methodTitle].deliveryDate)
                                var nonDayDefiniteDay = new Date(day.deliveryDate);
                                if (servicesDay.getTime() > nonDayDefiniteDay.getTime())
                                    services[service.methodTitle] = {
                                        deliveryDate: day.deliveryDate,
                                        service: service
                                    };
                            }
                        }
                    });
                });

                // create array for display in polymer
                Object.keys(services).forEach(function(service) {
                    var item = services[service];
                    var obj = {
                        id: item.service.id,
                        methodTitle: item.service.methodTitle,
                        price: item.service.price,
                    };

                    // non day definite
                    var startDate = new Date(item.deliveryDate);
                    var endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (item.service.maxDD - item.service.minDD));
                    obj.deliveryDateRange = self._formatNonDayDefiniteDate(startDate, endDate);
                    obj.deliveryTimeFrom = endDate.getTime();

                    results.push(obj);
                });
                return results;
            },

            _getDeliveryRateById: function(id) {
                var combinedRateGroups = this._data.dayDefinite.concat(this._data.nonDayDefinite);
                var rates = [];
                combinedRateGroups.forEach(function(group) {
                    rates = rates.concat(group.rates);
                });
                var resultList = rates.filter(function(rate) {
                    return rate.id == id
                });
                if (resultList.length) {
                    if (this.$.calendarDeliveriesOption.checked === true) {
                        for (var i = 0; i < resultList.length; i++) {
                            if ((moment(resultList[i].deliveryTimeTo).format("YYYY-MM-DD")) === moment(this.$$('mp-calendar').chosen).format("YYYY-MM-DD")) {
                                return resultList[i];
                            }
                        }
                    }
                    else {
                        return resultList[0];
                    }
                } else return null;
            },

            _processNonDayDefiniteData: function() {
                if (this._data.nonDayDefinite.constructor === Array && this._data.nonDayDefinite.length > 0) {
                    this._data.standardRates = this._getGroupedByService();
                    this.standardRates = this._data.standardRates;
                }
                else { // usefull for _checkForServices
                    this.standardRates = [];
                    this._data.standardRates = this.standardRates;
                }
            },

            _forceArray: function(o) {
                return ((o.constructor !== Array) ? [o] : o);
            },

            _makeCalendar: function() {
                this._findAllDeliveryDays();
                window.setTimeout(this._markDeliveryDays.bind(this), 500);
            },

            _makeMap: function(deliveryType, overlayWin) {
                var self = this;
                var home = null;
                // map options
                var mapOptions = {

                    // initial zoom level
                    zoom: self.startingZoomLevel,
                    minZoom: self.startingZoomLevel - 2,

                    // type of map (ROADMAP, SATELLITE, TERRAIN, HYBRID)
                    mapTypeId: google.maps.MapTypeId.TERRAIN,

                    // show or hide streetview control
                    streetViewControl: false,

                    // show or hide the google map UI
                    disableDefaultUI: self.hideMapUI,

                    // map controls (only if disableDefaultUI is false)
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                        position: google.maps.ControlPosition.TOP_RIGHT,
                    },

                    zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.SMALL,
                        position: google.maps.ControlPosition.TOP_RIGHT
                    },

                    // remove points of interest from the map so as not to interfere
                    styles: [{
                        "featureType": "poi",
                        "elementType": "labels",
                        "stylers": [{
                            "visibility": "off"
                        }]
                    }]
                };

                switch (overlayWin) {
                    case 'droppoint_info':
                        self._infoWindow = new google.maps.InfoWindow({
                            content: self.$.droppoint_info
                        });

                        self._map = new google.maps.Map(self.$.gfsMapCanvas, mapOptions);
                        this.$.gfsMapCanvas.map = self._map;
                        break;
                    case 'store_info':
                        self._storeInfoWindow = new google.maps.InfoWindow({
                            content: self.$.store_info
                        });

                        self._storeMap = new google.maps.Map(self.$.storeMapCanvas, mapOptions);
                        this.$.storeMapCanvas.map = self._storeMap;
                        break;
                    default:
                }

                //=== Home marker
                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    componentRestrictions: {
                        country: this.countryCode,
                        postalCode: this.postCode
                    }
                }, function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        var homeMarkerConfig = {
                            position: results[0].geometry.location,
                            //map: self._map,
                            animation: google.maps.Animation.DROP,
                            title: 'Home',
                            html: 'Home',
                            icon: self._getHomeIcon()
                        };

                        if (overlayWin === 'droppoint_info') {
                            marker = new google.maps.Marker(homeMarkerConfig);
                            self._map.setCenter(homeMarkerConfig.position);
                            marker.setMap(self._map);
                        }
                        else if (overlayWin === 'store_info') {
                            storeMarker = new google.maps.Marker(homeMarkerConfig);
                            self._storeMap.setCenter(homeMarkerConfig.position);
                            storeMarker.setMap(self._storeMap);
                        }

                        var getPreviousPos = Object.keys(previousPosition).length;
                        if (getPreviousPos > 0) {
                            self._map.panTo(previousPosition);
                            self._storeMap.panTo(previousPosition);
                        }
                    }
                    else {
                        console.log('Google Maps API ERROR - Geocode was not successful for the following reason: ' + status);
                    }
                });
            },

            _clearMarkers: function (markers, map) {
                for (var i = 0; i < markers.length; i++) {
                    if (map === 'dropPointMap') {
                        markers[i].setMap(null);
                    }
                    else {
                        markers[i].setMap(null);
                    }
                }
            },

            _loadDroppointMarkers: function (dropPointsArray) {
                var self = this;
                  //=== Drop point markers
                var marker;

                dropPointsArray.forEach(
                    function (pointItem) {
                        var getCountryCode = pointItem.geoLocation.countryCode;
                        var markerConfig = {
                            position: new google.maps.LatLng(pointItem.geoLocation.coordinates.latitude, pointItem.geoLocation.coordinates.longitude),
                            map: self._map,
                            animation: google.maps.Animation.DROP,
                            title: pointItem.droppointDescription,
                            customData: pointItem,
                            icon: self._droppointIcon(getCountryCode) + '/' + pointItem.providerName.toLowerCase() + '.png',
                            zIndex: google.maps.Marker.MAX_ZINDEX + 1
                        };
                        //console.log(pointItem.geoLocation.coordinates.longitude, pointItem.geoLocation.coordinates.latitude);
                        marker = new google.maps.Marker(markerConfig);
                        markers.push(marker);
                        marker.addListener('click', function (clickedMarker) {
                            self._selectDropPoint(this);
                        });
                        // add a link to the marker to get to it from the droppoint, need to animate and centre the marker if selecting from list view
                        pointItem.marker = marker;
                    }
                );

                google.maps.event.addListener(self._map, 'click', function(event) {
                    self._unselectDropPoint();
                    self.fire('hide-collectionInfo');
                });
            },

            _droppointIcon: function(countryCode) {
                var url = this.resolveUrl('//gfswidgetcdn.azurewebsites.net/images/widgets/droppoint');

                switch (countryCode) {
                    case "DE":
                        return url + '/DE';
                    case "FR":
                    case "BE":
                    case "ES":
                        return url + '/FR';
                    default:
                        return url + '/GB';

                }
            },

            _returnPostcode: function(postcode, deliveryType) {
                var self = this;
                var emptyPostcode = new RegExp(/^\s\s*/);

                if (postcode === "" || postcode.match(emptyPostcode)) {
                    self.$.errorNotification.text = "Please enter a valid postcode";
                    self.$.errorNotification.fitInto = self.$.gfsMapCanvas;
                    this.$.errorNotification.duration = 5000;
                    self.$.errorNotification.open();
                    return;
                }

                if (!!markers && deliveryType === 'dropPoint') {
                    this._clearMarkers(markers, 'dropPointMap');

                    if (this.useDroppointsStores) {
                        this._clearMarkers(storeMarkers, 'dropPointMap');
                    }
                }
                else {
                    this._clearMarkers(storeMarkers, 'storeMap');
                }

                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    componentRestrictions: {
                        country: this.countryCode,
                        postalCode: postcode
                    }
                }, function (results, status) {
                    self.initialAddress = postcode; // set the delivery address to the new one
                    if (status == google.maps.GeocoderStatus.OK) {
                        var position = results[0].geometry.location;
                        if (deliveryType === 'dropPoint') {
                            self._map.setCenter(position);
                        }
                        else {
                            self._storeMap.setCenter(position);
                        }
                        self.$.ajaxPostPostcode.headers = self._computeHeader();
                        self.$.ajaxPostPostcode.url = self._endPoint;
                        self.$.ajaxPostPostcode.body = self.$.ajaxPost.body;
                        self.$.ajaxPostPostcode.body.Request.Session.sessionID = self._sessionId;
                        self.$.ajaxPostPostcode.body.Request.Order.Transit.Recipient.Location.Postcode = postcode;
                        self.$.ajaxPostPostcode.generateRequest();
                    }
                    else {
                        console.log('Google Maps API ERROR - Geocode was not successful for the following reason: ' + status);
                        self.$.errorNotification.text = "Postcode not found in " + self.countryCode;

                        if (deliveryType === 'dropPoint') {
                            self.$.errorNotification.fitInto = self.$.gfsMapCanvas;
                        }
                        else {
                            self.$.errorNotification.fitInto = self.$.storeMapCanvas;
                        }

                        self.$.errorNotification.duration = 5000;
                        self.$.errorNotification.open();
                        return;
                    }
                });

            },

            _geoCoder: function(postcode, deliveryType) {
                var self = this;

                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    componentRestrictions: {
                        country: this.countryCode,
                        postalCode: postcode
                    }
                }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        if (deliveryType === 'dropPoint') {
                            self._map.setCenter(results[0].geometry.location);
                        }
                        else {
                            self._storeMap.setCenter(results[0].geometry.location);
                        }
                    }
                    else {
                        console.log('Google Maps API ERROR - Geocode was not successful for the following reason: ' + status);
                        self.$.errorNotification.text = "Postcode not found in " + self.countryCode;

                        if (deliveryType === 'dropPoint') {
                            self.$.errorNotification.fitInto = self.$.gfsMapCanvas;
                        }
                        else {
                            self.$.errorNotification.fitInto = self.$.storeMapCanvas;
                        }

                        self.$.errorNotification.duration = 5000;
                        self.$.errorNotification.open();
                    }
                });
            },

            _findPostcode: function (e) {
                e.preventDefault();
                var elem = Polymer.dom(e).localTarget.id;

                if (this.useDroppointsStores) {
                    this.$$('#toggleStoreOnMap').checked = false;
                    this.$$('#toggleDropPointsOnMap').checked = false;
                    this._storeDetailsClass = "fade-out";
                    this._dropPointDetailsClass = "fade-out";
                }

                this.fire('hide-collectionInfo');
                switch (elem) {
                    case "droppointSubmit":
                        return [
                            this.$.lastddPostcode.innerText = "Last searched postcode: " + this.$.droppointAddress.value,
                            this._returnPostcode(this.$.droppointAddress.value, "dropPoint"),
                            this.$.droppointAddress.value = ""
                        ];
                    case "storeSubmit":
                        return [
                            this.$.lastStorePostcode.innerText = "Last searched postcode: " + this.$.storeAddress.value,
                            this._returnPostcode(this.$.storeAddress.value, "store"),
                            this.$.storeAddress.value = ""
                        ];
                    default:
                }
            },

            _goToHome: function(e) {
                e.preventDefault();
                var elem = Polymer.dom(e).localTarget.parentElement.id;

                if (this.useDroppointsStores) {
                    this.$$('#toggleStoreOnMap').checked = false;
                    this.$$('#toggleDropPointsOnMap').checked = false;
                    this._storeDetailsClass = "fade-out";
                    this._dropPointDetailsClass = "fade-out";
                }

                this.fire('hide-collectionInfo');
                switch (elem) {
                    case "go-to-home-droppoint":
                        return this._geoCoder(this.$.homePostcodeDroppoint.value, "dropPoint");
                    case "go-to-home-store":
                        return this._geoCoder(this.$.homePostcodeStore.value, "store");
                    default:
                }
            },

            _getHomeIcon: function() {
                if (this.homeIcon) {
                    return this.homeIcon;
                } else {
                    return this.resolveUrl('//gfswidgetcdn.azurewebsites.net/images/widgets/map-home.png');
                }
            },

            _savePosition: function() {
                previousPosition = this._map.getCenter();
            },

            _locateMe: function() {
                var self = this;
                // Try HTML5 geolocation.
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                            var pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            self._map.setCenter(pos);
                            self._storeMap.setCenter(pos);
                        },
                        function() {
                            handleLocationError(true, self._infoWindow, GMap.getCenter());
                            handleLocationError(true, self._storeInfoWindow, GMap.getCenter());
                        }
                    );
                }
                else {
                    // Browser doesn't support Geolocation
                    //handleLocationError(false, infoWindow, GMap.getCenter());
                }
            },

            // dropPoints
            _loadDroppointMarkers: function (dropPointsArray) {
                var self = this;
                //=== Drop point markers
                var marker;

                dropPointsArray.forEach(
                    function (pointItem) {
                        if (pointItem.isStore == false) {
                            var getCountryCode = pointItem.geoLocation.countryCode;
                            var markerConfig = {
                                position: new google.maps.LatLng(pointItem.geoLocation.coordinates.latitude, pointItem.geoLocation.coordinates.longitude),
                                map: self._map,
                                animation: google.maps.Animation.DROP,
                                title: pointItem.droppointDescription,
                                customData: pointItem,
                                icon: self._droppointIcon(getCountryCode) + '/' + pointItem.providerName.toLowerCase() + '.png',
                                zIndex: google.maps.Marker.MAX_ZINDEX + 1
                            };

                            marker = new google.maps.Marker(markerConfig);
                            markers.push(marker);
                            marker.addListener('click', function (clickedMarker) {
                                self._selectDropPoint(this);
                            });
                            // add a link to the marker to get to it from the droppoint, need to animate and centre the marker if selecting from list view
                            pointItem.marker = marker;
                        }
                    }
                );

                google.maps.event.addListener(self._map, 'click', function(event) {
                    self._unselectDropPoint();
                    self._unselectStore();
                    self.fire('hide-collectionInfo');
                });
            },

            _removeDuplicateDropPoints: function (droppoints) {
                var a = droppoints.concat();

                for (var i = 0; i < a.length; ++i) {
                    for (var j = i + 1; j < a.length; ++j) {
                        if (a[i].droppointId === a[j].droppointId) {
                            a.splice(j--, 1);
                        }
                    }
                }
                return a;
            },

            _hideDropPoints: function() {
                if (this.$$('#toggleDropPointsOnMap').checked) {
                    var droppointItems = Polymer.dom(this.root).querySelectorAll("droppoint-delivery-selection");
                    this._showDropPointList = false;
                    this._clearMarkers(markers, 'dropPointMap');

                    for (var i = 0; i < droppointItems.length; i++) {
                        droppointItems[i].checked = false;
                        droppointItems[i].classList.add('hidden');
                    }
                }
                else {
                    this._loadDroppointMarkers(this._dropPoints);
                    this._showDropPointList = true;
                }
            },

            _showDropPointDetails: function() {
                this.mapHeight = this.$.gfsMapCanvas.clientHeight;
                this._storeDetailsClass = "fade-out";
                this._dropPointDetailsClass = "fade-in";
            },

            _hideDropPointDetails: function () {
                this._dropPointDetailsClass = "fade-out";
            },

            _showDropPointsView: function(e) {
                if (this.$.toggleDropPointsView.checked) {
                    this.$.dropPointListContainer.classList.add('hidden');
                    this.$.mapContainer.classList.remove('hidden');

                    if (!!this._selectedDropPoint && !!this._selectedDropPoint.chosen) {
                        this._fixMapMarker('droppoint');
                    }
                    else {
                        this._fixMapMarker('store');
                    }

                }
                else {
                    this.$.dropPointListContainer.classList.remove('hidden');
                    this.$.mapContainer.classList.add('hidden');
                }
            },

            _selectDropPoint: function(marker) {
                marker.customData.chosen = true;
                this.fire("droppoint-changed", marker.customData);
            },

            _unselectDropPoint: function() {
                if (this._selectedDropPoint) {
                    this._selectedDropPoint.chosen = false;

                    this.fire("droppoint-changed", this._selectedDropPoint);

                    if (this._currentMarker) {
                        this._currentMarker.setAnimation(null);
                    }

                    if (this._infoWindow) {
                        this._infoWindow.close();
                    }
                    this._hideDropPointDetails();
                }
            },

            droppointOpenChanged: function(_droppointOpened) {
                if (this._selectedDropPoint) {
                    this.set('_selectedDropPoint.chosen', _droppointOpened);
                    this.fire("droppoint-changed", this._selectedDropPoint);
                }
            },

            _droppointChanged: function(e) {
                console.log('_droppointChanged', e.detail);
                var changedDroppoint = e.detail;

                this._dropPointDetailsClass = "fade-out";
                this._storeDetailsClass = "fade-out";

                this.resetCloseCheckout();

                // clear any selected store
                if (this._selectedStore) {
                    this._selectedStore.chosen = false;
                }

                // todo provider id needs to be in here as well
                if (this._selectedDropPoint) {
                    if (changedDroppoint.droppointId !== this._selectedDropPoint.droppointId) {
                        this._unselectDropPoint();
                    }
                }
                this._selectedDropPoint = changedDroppoint;
                // find the marker for animation
                this._fixMapMarker('droppoint');

                var deliveries = this._findDropPointDeliveries(this._selectedDropPoint.providerId);
                this._selectedDroppoints = deliveries;

                var droppointItems = Polymer.dom(this.root).querySelectorAll(".droppoint-delivery-selection");
                for (var i = 0; i < droppointItems.length; i++) {
                    droppointItems[i].checked = false;
                }

                this.fire("getDroppointSelectedService");
                console.log("selected delivery servive: ", this.selectedServiceDetails);
            },

            _droppointById: function(providerId, droppointId) {
                for (var i = 0; i < this._dropPoints.length; i++) {
                    if ((this._dropPoints[i].providerId === providerId) && (this._dropPoints[i].droppointId === droppointId)) {
                        return this._dropPoints[i];
                    }
                }
            },

            _fixMapMarker: function(delivery) {
                var elem = this;

                switch (delivery) {
                    case 'droppoint':
                        if (this.$.toggleDropPointsView.checked && !!this._selectedDropPoint) {
                            if (!!this._currentMarker) {
                                this._currentMarker.setAnimation(null);
                            }
                            this._currentMarker = this._droppointById(this._selectedDropPoint.providerId, this._selectedDropPoint.droppointId).marker;
                            this._infoWindow.open(this._map, this._currentMarker);
                            this._infoWindow.opened = true;

                            if (!!this._storeInfoWindow && this._storeInfoWindow.opened) {
                                this._storeInfoWindow.close();
                            }

                            if (this.markerAmimation) {
                                this._currentMarker.setAnimation(google.maps.Animation.BOUNCE);
                            }

                            this.$.dropPointRadio.setAttribute('checked', 'true');
                            this._map.panTo(this._currentMarker.getPosition());
                        }
                        break;
                    case 'store':
                        if (!!this._selectedStore) {
                            if (!!this._currentMarker) {
                                this._currentMarker.setAnimation(null);
                            }
                            this._currentMarker = this._storeById(this._selectedStore.providerId, this._selectedStore.droppointId).marker;

                            if (!!this.$.storeMapCanvas.map) {
                                this._storeInfoWindow.open(this._storeMap, this._currentMarker);
                                this._storeInfoWindow.opened = true;
                            }
                            else {
                                if (!!this._storeInfoWindow) {
                                    this._storeInfoWindow.close()
                                }
                                else {
                                    this._storeInfoWindow = new google.maps.InfoWindow({
                                        content: elem.$.store_info
                                    });
                                }
                                this._storeInfoWindow.open(this._map, this._currentMarker);
                                this._storeInfoWindow.opened = true;

                                if (!!this._infoWindow && this._infoWindow.opened) {
                                    this._infoWindow.close();
                                }
                            }

                            if (this.markerAmimation) {
                                this._currentMarker.setAnimation(google.maps.Animation.BOUNCE);
                            }

                            this.$.storeRadio.setAttribute('checked', 'true');

                            if (!!this.$.storeMapCanvas.map) {
                                this._storeMap.panTo(this._currentMarker.getPosition());
                            }
                            else {
                                this._map.panTo(this._currentMarker.getPosition());
                            }
                        }
                        break;
                    default:
                        this.$.errorNotification.text = "No delivery option was passed."
                        this.$.errorNotification.open();
                }
            },

            _makeDateStr: function(d) {
                function pad(n, padSize) {
                    var str = n.toString();
                    var padZeros = (new Array(padSize)).join('0');
                    return (padZeros + str).substr(-padSize);
                }
                return (
                    pad(d.getFullYear(), 4) + '-' +
                    pad(d.getMonth() + 1, 2) + '-' +
                    pad(d.getDate(d), 2)
                );
            },

            _deliveryDateSelected: function (e) {
                var deliveries = this._findDayDefiniteDeliveries(e.detail.date);

                if (deliveries && deliveries.length > 0) {
                    this._selectedDayDeliveries = deliveries;
                    this.$.errorNotification.close();
                }
                else {
                    this._selectedDayDeliveries = [];
                    this.$$('mp-calendar').chosen = [];

                    if (this.showCalendarNoServices) {
                        this.$.errorNotification.text = this.calendarNoServices;
                        this.$.errorNotification.open();
                    }
                }
                this.fire("getCalendarSelectedService");
            },

            _findDayDefiniteDeliveries: function(onDate) {
                var dateStr = this._makeDateStr(onDate);
                if (typeof(this._deliveryDays[dateStr]) !== "undefined") {
                    return this._deliveryDays[dateStr];
                }
                else {
                    return null;
                }
            },

            _formatDayDefiniteDate: function(deliveryDate) {
                return 'estimated arrival:: ' + moment(deliveryDate).format("ddd, Do MMMM") + '';
            },

            _formatNonDayDefiniteDate: function(startDate, endDate) {
                return 'estimated arrival: ' + moment(startDate).format("ddd, Do MMMM") + ' - ' + moment(endDate).format("ddd, Do MMMM") + '';
            },

            _findDropPointDeliveries: function(providerId) {
                var self = this;
                var droppointIndex = providerId;
                if (typeof(this._deliveryDroppoints[droppointIndex]) !== "undefined") {
                    var results = [];
                    Object.keys(this._deliveryDroppoints[droppointIndex]).forEach(function (service) {
                        var item = self._deliveryDroppoints[droppointIndex][service];
                        var obj = {
                            id: item.service.id,
                            methodTitle: item.service.methodTitle,
                            price: item.service.price,
                        };
                        if (item.service.maxDD == item.service.minDD) {
                            // day definite
                            var startDate = new Date(item.deliveryDate);
                            obj.deliveryDateRange = self._formatDayDefiniteDate(startDate);
                        } else {
                            // non day definite
                            var startDate = new Date(item.deliveryDate);
                            var endDate = new Date(startDate);
                            endDate.setDate(endDate.getDate() + (item.service.maxDD - 1));
                            obj.deliveryDateRange = self._formatNonDayDefiniteDate(startDate, endDate);
                        }

                        if (self.taxAndDutyType.toLowerCase() === "charge" && self.taxAndDuty > 0) {
                            var gfsData = JSON.parse(atob(self.gfsData));
                            var countryCode = gfsData.Request.Order.Transit.Recipient.Location.CountryCode.Code;

                            if (countryCode !== "GB") {
                                service.price = service.price + self.taxAndDuty;
                            }
                        }

                        results.push(obj);
                    });
                    return results;
                } else {
                    return null;
                }
            },

            _processDeliveryArray: function(obj) {
                var self = this;
                obj.forEach(function(day) {
                    day.rates.forEach(function(service) {
                        if (service.serviceType.type === "dmStandardDropPoint") {
                            service.serviceType.droppointProviders.forEach(function(provider) {
                                if (typeof(self._deliveryDroppoints[provider.id]) === "undefined")
                                    self._deliveryDroppoints[provider.id] = [];
                                if (typeof(self._deliveryDroppoints[provider.id][service.methodTitle]) === "undefined") {
                                    self._deliveryDroppoints[provider.id][service.methodTitle] = {
                                        deliveryDate: day.deliveryDate,
                                        service: service
                                    };
                                } else {
                                    var objsDay = new Date(self._deliveryDroppoints[provider.id][service.methodTitle].deliveryDate);
                                    var droppointDay = new Date(day.deliveryDate);
                                    if (objsDay.getTime() > droppointDay.getTime())
                                    if (self._deliveryDroppoints[provider.id][service.methodTitle].deliveryDate < day.deliveryDate) {
                                        self._deliveryDroppoints[provider.id][service.methodTitle] = {
                                            deliveryDate: day.deliveryDate,
                                            service: service
                                        };
                                    }
                                }
                            });
                        }
                    });
                });


                obj.forEach(function (day) {
                    if (self._stores.length > 0) {
                        var id = self._stores[0].providerId;

                        day.rates.forEach(function (service) {
                            if (service.serviceType.type === "dmStandardStore") {
                                if (typeof (self._storesDelivery[id]) === "undefined") {
                                    self._storesDelivery[id] = [];
                                }

                                if (typeof (self._storesDelivery[id][service.methodTitle]) === "undefined") {
                                    self._storesDelivery[id][service.methodTitle] = {
                                        deliveryDate: day.deliveryDate,
                                        service: service
                                    };
                                }
                                else {
                                    var objsDay = new Date(self._storesDelivery[id][service.methodTitle].deliveryDate);
                                    var droppointDay = new Date(day.deliveryDate);
                                    if (objsDay.getTime() > droppointDay.getTime()) {
                                        if (self._storesDelivery[id][service.methodTitle].deliveryDate < day.deliveryDate) {
                                            self._storesDelivery[id][service.methodTitle] = {
                                                deliveryDate: day.deliveryDate,
                                                service: service
                                            };
                                        }
                                    }   
                                }
                            }
                        });
                    }
                });
            },

            _findAllDeliveryDroppoints: function() {
                this._processDeliveryArray(this._data.dayDefinite);
                this._processDeliveryArray(this._data.nonDayDefinite);
            },

            _findAllDeliveryDays: function() {
                //Make an index of delivery days, dmStandard
                var self = this;
                this._data.dayDefinite.forEach(function(item) {
                    var dateStr = self._makeDateStr(new Date(item.deliveryDate));
                    var deliveryDate = new Date(dateStr);
                    item.dateStr = dateStr;

                    self._deliveryDays[dateStr] = item.rates.filter(function(rate) {
                        return (rate.serviceType.type === "dmStandard");
                    });

                    if ((self._earliestDelivery == null) || deliveryDate < self._earliestDelivery) {
                        self._earliestDelivery = self._deliveryDays[dateStr];

                        if (self.taxAndDutyType.toLowerCase() === "charge" && self.taxAndDuty > 0) {
                            var gfsData = JSON.parse(atob(self.gfsData));
                            var countryCode = gfsData.Request.Order.Transit.Recipient.Location.CountryCode.Code;

                            if (countryCode !== "GB") {
                                for (var i = 0; i < self._earliestDelivery.length; i++) {
                                    self._earliestDelivery[i].price = self._earliestDelivery[i].price + self.taxAndDuty;
                                }
                            }
                        }
                    }
                });
            },

            // mark the delivery days in calendar
            _markDeliveryDays: function() {
                for (var dateStr in this._deliveryDays) {
                    var selector = 'mp-calendar .day[data-date="' + dateStr + '"]';

                    var results = document.querySelectorAll(selector);
                    if (results) {
                        for (var i = 0; i < results.length; i++) {
                            results[i].classList.add('highlighted');
                            results[i].classList.add('gfs-checkout');
                            results[i].classList.remove('disabledDay');
                        }
                    }
                }
                if (this.$.calendarPanel.opened === true) {
                    this._preselectForExpress();
                }
            },

            _calendarMonthChanged: function(e) {
                this._markDeliveryDays();
            },

            _preselectForStandard: function() {
                var cheapestMethod = null;
                var preselectDay = false;
                var items = this._data.standardRates;
                items.forEach(function(carrier) {
                    if (cheapestMethod === null || (carrier.price < cheapestMethod.price)) {
                        cheapestMethod = carrier;
                    }
                });

                this._selectCheapestMethod(cheapestMethod);
            },

            _preselectForExpress: function () {
                var cheapestMethod = null;
                var preselectDay = false;

                if (this.allowCalendarPreselect) {
                    items = this._earliestDelivery;
                    items.forEach(function (item) {
                        if (cheapestMethod === null || (item.price < cheapestMethod.price)) {
                            cheapestMethod = item;
                            preselectDay = true;
                        }
                    });
                }

                if (cheapestMethod) {
                    if (preselectDay) {
                        this.$$('mp-calendar').chosen = moment(cheapestMethod.deliveryTimeFrom).format('YYYY-MM-DD');
                        cheapestMethod.date = new Date(cheapestMethod.deliveryTimeFrom);
                        this.fire('dateSelected', cheapestMethod);

                        if(this.defaultDelivery === 'Express')
                            this._selectCheapestMethod(cheapestMethod);
                    }
                }
            },

            _selectCheapestMethod: function (cheapestMethod) {
                cheapestMethod.selected = true;
                var method = this._getDeliveryRateById(cheapestMethod.id);
                this.selectedServiceDetails.serviceId = method.id;
                this.selectedServiceDetails.service = method.methodTitle;
                this.selectedServiceDetails.serviceCode = method.carrierCode;
                this.selectedServiceDetails.carrier = method.carrierName;
                this.selectedServiceDetails.shipping = method.price;
                this.selectedServiceDetails.expDeliveryDateStart = moment(method.deliveryTimeFrom).toISOString();
                this.selectedServiceDetails.expDeliveryDateEnd = moment(method.deliveryTimeTo).add(method.maxDD - method.minDD, 'days').toISOString();
                this.selectedServiceDetails.checked = cheapestMethod.selected;
                this.selectedServiceDetails.currencySymbol = this.currencySymbol;

                this.closeCheckout.selectedDeliveryOptionID = method.deliveryOptionId;
                this.closeCheckoutData.checkoutSelectedServiceName = method.methodTitle;
                this.closeCheckoutData.checkoutSelectedPrice = method.price;

                if (this.$.dropPointDeliveriesOption.checked == true) {
                    this.selectedServiceDetails.collectionPoint = this._selectedDropPoint.droppointId;
                    this.selectedServiceDetails.deliveryAddress = this._selectedDropPoint.geoLocation;
                    this.closeCheckout.selectedDroppointId = this._selectedDropPoint.droppointId;
                    this.closeCheckoutData.checkoutSelectedDroppointAddress = this._selectedDropPoint.geoLocation.addressLines.toString();
                }
                else {
                    this.selectedServiceDetails.selectedDropopintId = null;
                    this.closeCheckout.selectedDroppointId = null;
                }

                this.fire('selectedServiceChanged', this.selectedServiceDetails);
                this.fire("getStandardSelectedService", this.selectedServiceDetails);

                var checkoutResultsData = document.getElementById(this.checkoutResults);
                if (!!checkoutResultsData) {
                    checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                }

                var sessionID = document.getElementById(this.sessionid);
                if (!!sessionID) {
                    sessionID.value = btoa(this._sessionId);
                }

                var checkoutData = document.getElementById(this.checkoutData);
                if (!!checkoutData) {
                    checkoutData.value = btoa(JSON.stringify(this.closeCheckoutData));
                }
            },

            _toggleCollapse: function(id) {
                //If I am open, close everyone
                //If I am closed, open me and close everyone
                var self = this;
                var myElement = this.$$('#' + id);
                var myState = myElement.opened;
                var collapseElements = Polymer.dom(this.root).querySelectorAll('iron-collapse');

                collapseElements.forEach(function(item) {
                    item.opened = false;
                    item.parentElement.querySelector(".arrow").classList.remove("less");
                });
                myElement.opened = !myState;

                var arrow = myElement.parentElement.querySelector(".arrow");
                if (myElement.opened) {
                    arrow.classList.add("less");
                }
                else {
                    arrow.classList.remove("less");
                }

                this.selectedServiceDetails = [];
                this.closeCheckout.selectedDeliveryOptionID = null;

                if (id === 'dropPointPanel') {
                    google.maps.event.trigger(self._map, 'resize');
                }
                else {
                    google.maps.event.trigger(self._storeMap, 'resize');
                }
            },

            _toggleStandardDeliveryPanelCollapse: function (e) {
                this._toggleCollapse('standardDeliveryPanel');

                var checkoutResultsData = document.getElementById(this.checkoutResults);
                if (!!checkoutResultsData) {
                    checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                }

                var standardItems = Polymer.dom(this.root).querySelectorAll(".standard-delivery-selection");
                for (var i = 0; i < standardItems.length; i++) {
                    standardItems[i].checked = false;
                }

                var calendarItems = Polymer.dom(this.root).querySelectorAll(".calendar-delivery-selection");
                for (var i = 0; i < calendarItems.length; i++) {
                    calendarItems[i].checked = false;
                }

                var droppointItems = Polymer.dom(this.root).querySelectorAll(".droppoint-delivery-selection");
                for (var i = 0; i < droppointItems.length; i++) {
                    droppointItems[i].checked = false;
                }

                var storeItems = Polymer.dom(this.root).querySelectorAll(".store-delivery-selection");
                for (var i = 0; i < storeItems.length; i++) {
                    droppointItems[i].checked = false;
                }

                this.fire("getStandardSelectedService");
                this.fire("getCalendarSelectedService");
                this.fire("getDroppointSelectedService");
                this.fire("getStoreSelectedService");
            },

            _toggleCalendarPanelCollapse: function (e) {
                this._toggleCollapse('calendarPanel');

                var checkoutResultsData = document.getElementById(this.checkoutResults);
                if (!!checkoutResultsData) {
                    checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                }

                // if a service is selected disable it
                var standardItems = Polymer.dom(this.root).querySelectorAll(".standard-delivery-selection");
                for (var i = 0; i < standardItems.length; i++) {
                    standardItems[i].checked = false;
                }

                var calendarItems = Polymer.dom(this.root).querySelectorAll(".calendar-delivery-selection");
                for (var i = 0; i < calendarItems.length; i++) {
                    calendarItems[i].checked = false;
                }

                var droppointItems = Polymer.dom(this.root).querySelectorAll("droppoint-delivery-selection");
                for (var i = 0; i < droppointItems.length; i++) {
                    droppointItems[i].checked = false;
                }

                var storeItems = Polymer.dom(this.root).querySelectorAll(".store-delivery-selection");
                for (var i = 0; i < storeItems.length; i++) {
                    storeItems[i].checked = false;
                }

                // open available services
                this._preselectForExpress();

                // reset selected service
                this.fire("getStandardSelectedService");
                this.fire("getCalendarSelectedService");
                this.fire("getDroppointSelectedService");
                this.fire("getStoreSelectedService");
            },

            _toggleDropPointPanelCollapse: function (e) {
                var self = this;

                this._toggleCollapse('dropPointPanel');
                this.$$(".search-postcode-wrap").classList.remove('hidden');
                this.$$("#droppoint-delivery-options").classList.remove('hidden');
                this.$.lastddPostcode.innerText = "";

                var checkoutResultsData = document.getElementById(this.checkoutResults);
                if (!!checkoutResultsData) {
                    checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                }

                var standardItems = Polymer.dom(this.root).querySelectorAll(".standard-delivery-selection");
                for (var i = 0; i < standardItems.length; i++) {
                    standardItems[i].checked = false;
                }

                var calendarItems = Polymer.dom(this.root).querySelectorAll(".calendar-delivery-selection");
                for (var i = 0; i < calendarItems.length; i++) {
                    calendarItems[i].checked = false;
                }

                var droppointItems = Polymer.dom(this.root).querySelectorAll(".droppoint-delivery-selection");
                for (var i = 0; i < droppointItems.length; i++) {
                    droppointItems[i].checked = false;
                }

                var storeItems = Polymer.dom(this.root).querySelectorAll(".store-delivery-selection");
                for (var i = 0; i < storeItems.length; i++) {
                    storeItems[i].checked = false;
                }

                this.fire("getStandardSelectedService");
                this.fire("getCalendarSelectedService");
                this.fire("getDroppointSelectedService");
                this.fire("getStoreSelectedService");

                if (this.$.dropPointPanel.opened === true) {
                    this._fixMapMarker('droppoint');
                    if (!!this._selectedDropPoint) {
                        this.fire("droppoint-changed", this._selectedDropPoint);
                    }
                    google.maps.event.trigger(this._map, 'resize');
                    window.setTimeout(self._map.panTo(marker.position), 100);
                }
            },

            _toggleStorePanelCollapse: function(e) {
                var elem = this;

                this._toggleCollapse('storePanel');
                this.$$(".search-postcode-wrap").classList.remove('hidden');
                //this.$$("#store-delivery-options").classList.remove('hidden');
                this.$.lastStorePostcode.innerText = "";

                var checkoutResultsData = document.getElementById(this.checkoutResults);
                if (!!checkoutResultsData) {
                    checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                }

                var standardItems = Polymer.dom(this.root).querySelectorAll(".standard-delivery-selection");
                for (var i = 0; i < standardItems.length; i++) {
                    standardItems[i].checked = false;
                }

                var calendarItems = Polymer.dom(this.root).querySelectorAll(".calendar-delivery-selection");
                for (var i = 0; i < calendarItems.length; i++) {
                    calendarItems[i].checked = false;
                }

                var droppointItems = Polymer.dom(this.root).querySelectorAll(".droppoint-delivery-selection");
                for (var i = 0; i < droppointItems.length; i++) {
                    droppointItems[i].checked = false;
                }

                var storeItems = Polymer.dom(this.root).querySelectorAll(".store-delivery-selection");
                for (var i = 0; i < storeItems.length; i++) {
                    storeItems[i].checked = false;
                }

                this.fire("getStandardSelectedService");
                this.fire("getCalendarSelectedService");
                this.fire("getDroppointSelectedService");
                this.fire("getStoreSelectedService");

                if (this.$.storePanel.opened === true) {
                    this._fixMapMarker('store', this._storeMap);
                    if (!!this._selectedStore) {
                        this.fire("store-changed", this._selectedStore);
                    }
                    google.maps.event.trigger(this._storeMap, 'resize');
                    window.setTimeout(elem._storeMap.panTo(storeMarker.position), 100);
                }
            },

            updateDeliveryOptions: function (e) {
                if (e.target.checked) {
                    if (e.target.id !== "-3") {
                        var method = this._getDeliveryRateById(e.target.id);
                        this.selectedServiceDetails.serviceId = method.id;
                        this.selectedServiceDetails.service = method.methodTitle;
                        this.selectedServiceDetails.serviceCode = method.carrierCode;
                        this.selectedServiceDetails.carrier = method.carrierName;
                        this.selectedServiceDetails.shipping = method.price;
                        this.selectedServiceDetails.expDeliveryDateStart = moment(method.deliveryTimeFrom).toISOString();
                        this.selectedServiceDetails.expDeliveryDateEnd = moment(method.deliveryTimeTo).add(method.maxDD - method.minDD, 'days').toISOString();
                        this.selectedServiceDetails.currencySymbol = this.currencySymbol;
                        this.closeCheckoutData.checkoutSelectedServiceName = method.methodTitle;
                        this.closeCheckoutData.checkoutSelectedPrice = method.price;

                        if (this.$.dropPointDeliveriesOption.checked == true) {
                            if (!!this._selectedDropPoint && this._selectedDropPoint.chosen) {
                                this.selectedServiceDetails.collectionPoint = this._selectedDropPoint.droppointId;
                                this.selectedServiceDetails.deliveryAddress = this._selectedDropPoint.geoLocation;
                                this.closeCheckout.selectedDroppointId = this._selectedDropPoint.droppointId;
                                this.closeCheckoutData.checkoutSelectedDroppointAddress = this._selectedDropPoint.geoLocation.addressLines.toString();
                                this.closeCheckout.isStore = false;
                            }
                            else {
                                this.selectedServiceDetails.collectionPoint = this._selectedStore.droppointId;
                                this.selectedServiceDetails.deliveryAddress = this._selectedStore.geoLocation;
                                this.closeCheckout.selectedDroppointId = this._selectedStore.droppointId;
                                this.closeCheckoutData.checkoutSelectedDroppointAddress = this._selectedStore.geoLocation.addressLines.toString();
                                this.closeCheckout.isStore = true;
                            }
                        }
                        else if (this.$.storeDeliveriesOption.checked == true) {
                            this.selectedServiceDetails.collectionPoint = this._selectedStore.droppointId;
                            this.selectedServiceDetails.deliveryAddress = this._selectedStore.geoLocation;
                            this.closeCheckout.selectedDroppointId = this._selectedStore.droppointId;
                            this.closeCheckout.isStore = true;
                        }
                        else {
                            this.closeCheckout.selectedDroppointId = null;
                            this.closeCheckout.isStore = false;
                        }

                        this.fire('selectedServiceChanged', this.selectedServiceDetails);

                        if (this.$.standardDeliveriesOption.checked === true) {
                            this.fire("getStandardSelectedService", this.selectedServiceDetails);
                        }

                        if (this.$.calendarDeliveriesOption.checked === true) {
                            this.fire("getCalendarSelectedService", this.selectedServiceDetails);
                        }

                        if (this.$.dropPointDeliveriesOption.checked === true) {
                            this.fire("getDroppointSelectedService", this.selectedServiceDetails);
                        }

                        if (this.$.storeDeliveriesOption.checked === true) {
                            this.fire("getStoreSelectedService", this.selectedServiceDetails);
                        }


                        this.closeCheckout.selectedDeliveryOptionID = method.deliveryOptionId;
                    }

                    var checkoutResultsData = document.getElementById(this.checkoutResults);
                    if (!!checkoutResultsData) {
                        checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                    }

                    var sessionID = document.getElementById(this.sessionid);
                    if (!!sessionID) {
                        sessionID.value = btoa(this._sessionId);
                    }

                    var checkoutData = document.getElementById(this.checkoutData);
                    if (!!checkoutData) {
                        checkoutData.value = btoa(JSON.stringify(this.closeCheckoutData));
                    }
                }
            },

            _noServices: function(e) {
                // Check if the default-* values are defined
                if (this.defaultService != "" || this.defaultCarrier != "" || this.defaultMinDeliveryTime != "" || this.defaultMaxDeliveryTime != "" || this.defaultPrice != "") {
                    // create an array for polymer
                    this.standardRates = [];
                    var today = new Date();
                    var startDate = new Date(today);
                    startDate.setDate(startDate.getDate() + parseInt(this.defaultMinDeliveryTime));
                    var endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (this.defaultMaxDeliveryTime - 1));

                    this.standardRates = [{
                        id: -3,
                        methodTitle: this.defaultService,
                        price: this.defaultPrice,
                        deliveryDateRange: this._formatNonDayDefiniteDate(startDate, endDate),
                        selected: true,
                        carrier: this.defaultCarrier
                    }];

                    var method = this.standardRates.shift();
                    this.selectedServiceDetails.serviceId = method.id;
                    this.selectedServiceDetails.service = this.defaultService;
                    this.selectedServiceDetails.serviceCode = this.defaultCarrierCode;
                    this.selectedServiceDetails.carrier = this.defaultCarrier;
                    this.selectedServiceDetails.shipping = this.defaultPrice;
                    this.selectedServiceDetails.expDeliveryDateStart = startDate;
                    this.selectedServiceDetails.expDeliveryDateEnd = endDate;
                    this.selectedServiceDetails.deliveryAddress = actualPost.Request.Order.Transit.Recipient.Location;

                    this.fire('selectedServiceChanged', this.selectedServiceDetails);

                    if (this.$.standardDeliveriesOption.checked === true) {
                        this.fire("getStandardSelectedService", this.selectedServiceDetails);
                    }
                }
                else {
                    this.standardRates = [];
                    this.$.errorNotification.text = "The default service has not been configured, please contact website support";
                    this.$.errorNotification.duration = 8000;
                    this.$.errorNotification.open();
                }
            },

            // stores
            _loadStoreMarkers: function(storesArray, toMap) {
                var elem = this;
                var storeMarker;
                var dropPointsStoreMarker;

                if (storesArray) {
                    if (storesArray.length == 0) {
                        this.$.errorNotification.text = "There are no available stores";
                        this.$.errorNotification.open();
                        return;
                    }

                    storesArray.forEach(
                        function (pointItem) {
                            var getCountryCode = pointItem.geoLocation.countryCode;
                            var markerConfig = {
                                position: new google.maps.LatLng(pointItem.geoLocation.coordinates.latitude, pointItem.geoLocation.coordinates.longitude),
                                map: toMap,
                                animation: google.maps.Animation.DROP,
                                title: pointItem.droppointDescription,
                                customData: pointItem,
                                icon: elem._storeIcon(),
                                zIndex: google.maps.Marker.MAX_ZINDEX + 1
                            };
                            storeMarker = new google.maps.Marker(markerConfig);
                            storeMarkers.push(storeMarker);

                            storeMarker.addListener('click', function (clickedMarker) {
                                elem._selectStore(this);
                            });
                            // add a link to the marker to get to it from the droppoint, need to animate and centre the marker if selecting from list view
                            pointItem.marker = storeMarker;
                        }
                    );

                    google.maps.event.addListener(elem._map, 'click', function (event) {
                        elem._unselectStore();
                        elem.fire('hide-collectionInfo');
                    });

                    if (!!this.$.storeMapCanvas.map) {
                        google.maps.event.addListener(elem._storeMap, 'click', function (event) {
                            elem._unselectStore();
                            elem.fire('hide-collectionInfo');
                        });
                    }
                }
            },

            _storeIcon: function () {
                var icon;

                if (!!this.storeMapIcon) {
                    icon = this.resolveUrl(this.storeMapIcon);
                }
                else {
                    icon = this.resolveUrl('//gfswidgetcdn.azurewebsites.net/images/widgets/store-map-icon.png');
                }
                return icon;
            },

            _showStores: function() {
                if (this.$$('#toggleStoreOnMap').checked) {
                    if (!this.useStores) {
                        this._showStoreList = true;
                        this._loadStoreMarkers(this._stores, this._map);
                    }

                }
                else {
                    this._removeStoreMarkers();
                    this._showStoreList = false;
                }
            },

            _showStoreMarkers: function(map) {
                for (var i = 0; i < storeMarkers.length; i++) {
                    storeMarkers[i].setMap(map);
                }
            },

            _removeStoreMarkers: function() {
                for (var i = 0; i < storeMarkers.length; i++) {
                    storeMarkers[i].setMap(null);
                }
            },

            _hideStoreDetails: function() {
                this._storeDetailsClass = "fade-out";
            },

            _processStoreData: function() {
                if (this._data.droppoints.constructor === Array && this._data.droppoints.length > 0) {
                    this._data.stores = this._getStores();
                    this._stores = this._data.stores;
                }
                else {
                    this._stores = [];
                    this._data.stores = this._stores;
                }
            },

            _getStores: function() {
                var elem = this;
                var retval = [];

                this._data.droppoints.forEach(function(dropPoint) {
                    if (dropPoint.isStore == true) {
                        retval.push(dropPoint)
                    }
                });

                return retval;
            },

            _unselectStore: function () {
                if (this._selectedStore) {
                    this._selectedStore.chosen = false;

                    if (this._currentMarker) {
                        this._currentMarker.setAnimation(null);
                    }

                    if (this._storeInfoWindow) {
                        this._storeInfoWindow.close();
                    }
                    this._hideStoreDetails();
                }
            },

            storeOpenChanged: function (_storeOpened) {
                if (this._selectedStore) {
                    this.set('_selectedStore.chosen', _storeOpened);
                    this.fire("store-changed", this._selectedStore);
                }
            },

            _storeById: function (providerId, droppointId) {
                for (var i = 0; i < this._stores.length; i++) {
                    if ((this._stores[i].providerId === providerId) && (this._stores[i].droppointId === droppointId)) {
                        return this._stores[i];
                    }
                }
            },

            _storeChanged: function(e) {
                console.log('_storeChanged', e.detail);
                var changedStore = e.detail;

                this._dropPointDetailsClass = "fade-out";
                this._storeDetailsClass = "fade-out";

                this.resetCloseCheckout();

                // clear any selected droppointId
                if (this._selectedDropPoint) {
                    this._selectedDropPoint.chosen = false;
                }

                if (this._selectedStore) {
                    if (changedStore.droppointId !== this._selectedStore.droppointId) {
                        this._unselectStore();
                    }
                }

                this._selectedStore = changedStore;
                this._fixMapMarker('store');

                var deliveries = this._findStoreDeliveries(this._selectedStore.providerId);

                if (this.useStores) {
                    this._selectedStores = deliveries

                    var storeItems = Polymer.dom(this.root).querySelectorAll(".store-delivery-selection");

                    for (var i = 0; i < storeItems.length; i++) {
                        storeItems[i].checked = false;
                    }

                    this.fire("getStoreSelectedService");
                }
                else {
                    this._selectedDroppoints = deliveries;

                    var droppointItems = Polymer.dom(this.root).querySelectorAll(".droppoint-delivery-selection");

                    for (var i = 0; i < droppointItems.length; i++) {
                        droppointItems[i].checked = false;
                    }

                    this.fire("getDroppointSelectedService");
                }

                this.fire('hide-collectionInfo');
            },

            _selectStore: function(marker) {
                marker.customData.chosen = true;
                this.fire("store-changed", marker.customData);
            },

            _showStoreDetails: function() {
                this.mapHeight = this.$.storeMapCanvas.clientHeight;

                if (this.mapHeight == 0) {
                    this.mapHeight = this.$.gfsMapCanvas.clientHeight;
                }

                this._dropPointDetailsClass = "fade-out";
                this._storeDetailsClass = "fade-in";
            },

            _findStoreDeliveries: function (providerId) {
                var self = this;
                var droppointIndex = providerId;
                if (typeof (this._storesDelivery[droppointIndex]) !== "undefined") {
                    var results = [];
                    Object.keys(this._storesDelivery[droppointIndex]).forEach(function (service) {
                        var item = self._storesDelivery[droppointIndex][service];
                        var obj = {
                            id: item.service.id,
                            methodTitle: item.service.methodTitle,
                            price: item.service.price,
                        };
                        if (item.service.maxDD == item.service.minDD) {
                            // day definite
                            var startDate = new Date(item.deliveryDate);
                            obj.deliveryDateRange = self._formatDayDefiniteDate(startDate);
                        } else {
                            // non day definite
                            var startDate = new Date(item.deliveryDate);
                            var endDate = new Date(startDate);
                            endDate.setDate(endDate.getDate() + (item.service.maxDD - 1));
                            obj.deliveryDateRange = self._formatNonDayDefiniteDate(startDate, endDate);
                        }

                        if (self.taxAndDutyType.toLowerCase() === "charge" && self.taxAndDuty > 0) {
                            var gfsData = JSON.parse(atob(self.gfsData));
                            var countryCode = gfsData.Request.Order.Transit.Recipient.Location.CountryCode.Code;

                            if (countryCode !== "GB") {
                                obj.price = obj.price + self.tataxAndDutyTypexAndDuty;
                            }
                        }

                        results.push(obj);
                    });
                    return results;
                } else {
                    return null;
                }
            },

            _showStoresView: function () {
                if (this.$.toggleStoresView.checked) {
                    this.$.storeListContainer.classList.add('hidden');
                    this.$.mapStoreContainer.classList.remove('hidden');
                    this._fixMapMarker('store');
                }
                else {
                    this._showStoreList = true;
                    this._loadStoreMarkers(this._stores, this._storeMap);
                    this.$.storeListContainer.classList.remove('hidden');
                    this.$.mapStoreContainer.classList.add('hidden');
                }
            },

            resetCloseCheckout: function () {
                this.closeCheckout.selectedDeliveryOptionID = null;
                this.closeCheckout.selectedDroppointId = null;
                this.closeCheckout.isStore = false;

                var checkoutResultsData = document.getElementById(this.checkoutResults);
                if (!!checkoutResultsData) {
                    checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                }
            },

            lccNotification: function () {
                var lccCharge = Polymer.dom(this.root).querySelectorAll(".lcc-charge");
                var lccEstimate = Polymer.dom(this.root).querySelectorAll(".lcc-estimate");
                var gfsData = JSON.parse(atob(this.gfsData));
                var countryCode = gfsData.Request.Order.Transit.Recipient.Location.CountryCode.Code;

                // hide all
                for (var i = 0; i < lccCharge.length; i++) {
                    lccCharge[i].classList.add('hidden');
                }

                for (var i = 0; i < lccEstimate.length; i++) {
                    lccEstimate[i].classList.add('hidden');
                }

                if (countryCode !== "GB") {
                    if (this.showDutyMessage) {
                        if (this.taxAndDuty > 0) {
                            this.taxAndDutyPrice = this.taxAndDuty.toFixed(2);

                            if (this.taxAndDutyType.toLowerCase() === "estimate") {
                                for (var i = 0; i < lccCharge.length; i++) {
                                    lccCharge[i].classList.add('hidden');
                                }

                                for (var i = 0; i < lccEstimate.length; i++) {
                                    lccEstimate[i].classList.remove('hidden');
                                }
                            }
                            else {
                                for (var i = 0; i < lccEstimate.length; i++) {
                                    lccEstimate[i].classList.add('hidden');
                                }

                                for (var i = 0; i < lccCharge.length; i++) {
                                    lccCharge[i].classList.remove('hidden');
                                }
                            }
                        }
                    }
                }
            },

            taxAndDutyTypeChanged: function (val, oldVal) {
                if (this.taxAndDutyType.toLowerCase() !== oldVal && oldVal !== undefined) {
                    if (this.taxAndDutyType.toLowerCase() === "charge" || this.taxAndDutyType.toLowerCase() === "estimate") {
                        var gfsData = JSON.parse(atob(this.gfsData));
                        var countryCode = gfsData.Request.Order.Transit.Recipient.Location.CountryCode.Code;

                        if (countryCode !== "GB") {
                            this.$$('#standard-loading').classList.remove('hidden');
                            this.$$('.services').classList.add('hidden');
                            this.$.standardDeliveryPanel.opened = false;
                            this.$.calendarPanel.opened = false;
                            this.$.dropPointPanel.opened = false;
                            this.$.storePanel.opened = false;
                            this.queryServer(this.accessToken, this.gfsData);
                        }
                    }
                }
            },

            taxAndDutyValueChanged: function (val, oldVal) {
                if (this.taxAndDuty !== oldVal && oldVal !== undefined) {
                    var gfsData = JSON.parse(atob(this.gfsData));
                    var countryCode = gfsData.Request.Order.Transit.Recipient.Location.CountryCode.Code;

                    if (countryCode !== "GB") {
                        this.$$('#standard-loading').classList.remove('hidden');
                        this.$$('.services').classList.add('hidden');
                        this.taxAndDutyPrice = val.toFixed(2);
                        this.$.standardDeliveryPanel.opened = false;
                        this.$.calendarPanel.opened = false;
                        this.$.dropPointPanel.opened = false;
                        this.$.storePanel.opened = false;
                        this.queryServer(this.accessToken, this.gfsData);
                    }
                }
            }
        });
    </script>
</dom-module>
