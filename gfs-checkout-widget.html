<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../brick-calendar/dist/brick-calendar.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html" />
<link rel="import" href="../iron-list/iron-list.html" />
<link rel="import" href="../iron-collapse/iron-collapse.html" />
<link rel="import" href="../gfs-droppoint/gfs-droppoint.html" />
<link rel="import" href="../gfs-delivery-address/gfs-delivery-address.html" />
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html" />
<link rel="import" href="../paper-spinner/paper-spinner.html" />
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-button/paper-button.html">

<script src="../momentjs/min/moment.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMQhcXM06TZBHZ95LwJBRVGSV4CqUQMpI&libraries=places"></script>

<!--
    `gfs-checkout`
    A polymer widget to provides a rich user interface that interacts with the GFS Checkout 
    service in order to provide a wide range of easily configured delivery options.

    @demo demo/index.html
-->


<dom-module id="gfs-checkout">
    <template>
        <style>
            :host {
                --white: #fff;
                --grey: #797979;
                font-family: "Helvetica Neue", Verdana, Arial, sans-serif;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            h3 {
                margin: 0;
                font-family: "Helvetica Neue", Verdana, Arial, sans-serif;
                clear: left;
            }

            .toggle-title {
                width: 100%;
                cursor: pointer;
            }

            .toggle-content {
                margin-top: 10px;
                margin-bottom: 10px;
            }

            .hidden {
                display: none;
                z-index: 0;
            }

            input[type=radio] {
                margin: 0;
                vertical-align: middle;
                display: inline-block
            }

            ul {
                padding: 5px;
            }

            li {
                width: 100%;
                display: inline-block;
                vertical-align: middle
            }

                li label {
                    margin-top: 5px;
                    margin-left: 4px;
                    vertical-align: top
                }

                    li label:hover {
                        cursor: pointer
                    }

            #mapContainer {
                display: block;
                position: relative;
            }

            #gfsMapCanvas {
                height: 400px;
                top: 0;
                left: 0;
            }

            #gfsSidebar {
                display: block;
                width: 350px;
                overflow-y: auto;
                padding: 10px;
            }

            .locateme-wrap {
                z-index: 2;
                position: absolute;
                right: 10px;
                bottom: 21px;
            }

            #locateme {
                display: none;
            }

            #dropPointDetails {
                position: absolute;
                z-index: 1;
            }

            #droppoint_overlay {
                width: 240px;
                height: 400px;
                background: rgba(0, 0, 0, .8);
                position: absolute;
                top: 0;
                left: 0;
                border-right: 1px solid #b9b9b9;
                margin: auto;
                color: silver;
            }

                #droppoint_overlay_close {
                    position: absolute;
                    top: 32px;
                    right: 32px;
                    margin-top: -28px;
                    margin-right: -20px;
                }

            #toggleDropPointsViewControls {
                display: flex;
                margin: 0 0 20px;
            }

            .toggle-label {
                display: inline-block;
                font-size: 18px;
                margin-right: 0.4em;
            }

            .fade-in {
                transition: opacity 400ms ease-in;
                z-index: 2;
            }

            .fade-out {
                opacity: 0.0;
                transition: opacity 400ms ease-in;
                z-index: 0 !important;
            }

            paper-toggle-button.gfs-toggle {
                display: inline-block;
                --paper-toggle-button-checked-bar-color: #909090;
                --paper-toggle-button-checked-button-color: #909090;
                --paper-toggle-button-checked-ink-color: #909090;
                --paper-toggle-button-unchecked-bar-color: #909090;
                --paper-toggle-button-unchecked-button-color: #909090;
                --paper-toggle-button-unchecked-ink-color: #909090;
            }

            a.droppoint_info,
            a.droppoint_info:visited,
            a.droppoint_info:active {
                text-decoration: none;
                color: #29a54f;
                font-size: 11px;
                font-family: "Raleway", "Helvetica Neue", Verdana, Arial, sans-serif;
                font-weight: bold;
            }

                a.droppoint_info:hover {
                    text-decoration: underline;
                }

            .highlight {
                color: var(--white) !important;
                background-color: #90dca7 !important;
            }

            .toggle-content {
                padding-left: 2px;
            }

            .cardList {
                display: flex;
                flex-wrap: wrap;
                height: 730px;
                overflow-x: hidden;
                overflow-y: scroll;
            }

            div.dark .open-late {
                -webkit-filter: invert(1);
                filter: invert(1);
            }

            div#gfsMapCanvas .loading {
                margin: auto;
                width: 100px;
                padding-top: 120px;
            }

            paper-spinner#map-spinner {
                width: 100px;
                height: 100px;
            }

            div.cardList .loading {
                margin: auto;
                width: 100px;
                padding-top: 50px;
            }

            paper-spinner#list-spinner {
                width: 100px;
                height: 100px;
            }


            /* mp customization */
            #dropPointListContainer h3 {
                margin: 20px 0 10px;
                font-size: 20px;
                border-bottom: 1px solid #ccc;
            }

            .dp-card-margin {
                margin: 0 20px 0 0;
            }

                .dp-card-margin:nth-child(2n+1) {
                    margin-right: 0;
                }

            h3.carrier-name {
                font-size: 20px;
                margin: 0;
            }

            ul.carrier-list {
                margin-bottom: 10px;
            }

                ul.carrier-list:last-child {
                    margin-bottom: 5px;
                }

            li.gfsStd label, li.delivery-place label {
                margin: 0 0 0 4px;
                vertical-align: 0;
                display: initial;
            }

            li.delivery-place label {
                margin-bottom: 0;
            }

            #calendarPanel {
                padding: 15px;
            }

            span.gfsmethodname {
                margin: 3px 0 0;
            }

            .toggle-content {
                margin-top: 0;
                /*padding: 10px 0 0 18px;
                border-top: 1px solid #ccc;
                border-bottom: 1px solid #ccc;*/
            }

            .header {
                padding: 0 10px;
                line-height: 50px;
            }

                .header h3:hover {
                    cursor: pointer;
                }

            .header {
                background: var(--white);
                margin: 0 0 15px;
                padding-top: 5px;
                box-shadow: 0 0 1px 0 rgba(0, 0, 0, 0.1), 0 0 1px 0 rgba(0, 0, 0, 0.1), 0 1px 1px -1px rgba(0, 0, 0, 0.2);
            }

                .header label h3 {
                    color: var(--grey);
                    font-size: 22px;
                    margin-bottom: 0;
                    padding: 0 0 0 5px;
                    display: inline-block;
                    vertical-align: middle
                }

            div.header:last-child {
                margin: 0;
            }

            .selected-radio-options {
                transition: all .2s ease-in-out;
                transform: scale(1.01);
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
                /*box-shadow: 0 0 2px 2px rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 4px -3px rgba(0, 0, 0, 0.2)*/
            }

            .droppoint-margin {
                margin-right: 20px;
                position: relative;
            }

                .droppoint-margin:nth-child(2n+1) {
                    margin-right: 0;
                }

            #gfsMapCanvas {
                margin: 0 0 20px;
                position: relative;
            }

            paper-spinner#standard-spinner {
                width: 100px;
                height: 100px;
                position: relative;
                left: 50%;
                margin-left: -50px;
            }

            paper-spinner#calendar-spinner {
                width: 100px;
                height: 100px;
                position: relative;
                left: 50%;
                margin-left: -50px;
            }

            paper-spinner#search-spinner {
                width: 100px;
                height: 100px;
                margin-top: -50px;
                margin-left: -50px;
                top: 50%;
                left: 50%;
            }

            .search-postcode-wrap {
                margin: 10px 0;
                width: 330px;
            }

            #droppointAddress.form-control {
                display: inline-block;
                width: 203px;
                color: #797979;
                margin: 0 5px 0 0;
                float: left;
            }

            #droppointSubmit {
                color: #797979;
            }

            #go-to-home-address {
                width: 60px;
                height: 57px;
                margin: 0;
                padding: 6px 16.7px;
                position: absolute;
                right: 20px;
                bottom: 20px;
                z-index: 1;
                border-radius: 50%
            }

                #go-to-home-address img {
                    margin: 9px 0 0 1px
                }

            #wrongPostoce {
                color: #d60000;
            }

            #errorNotification {
                --paper-toast-background-color: red;
                --paper-toast-color: white;
            }

            /* calendar */
            #calendar-widget { width: 100%; border: none; }

                #calendar-widget ::content .calendar .month { width: 100%; }

                #calendar-widget ::content .calendar .month .day {
                    width: 14.2%;
                    font-size: 16px;
                    background: #E4E4E4 none;
                }

                #calendar-widget ::content .calendar .month .week { height: 3em; line-height: 3em; }

                #calendar-widget ::content .calendar .month .weekday-labels { height: 3em; line-height: 3em; }

                #calendar-widget ::content .calendar .month .weekday-label {
                    width: 14.2%;
                    font-size: 16px;
                    color: white;
                    background-color: #89898a;
                    margin-top: 1px!important;
                    margin-right: 1px!important;
                }

                #calendar-widget ::content .calendar .month .month-label {
                    border: none;
                    color: #8E8E8E;
                    font-size: 16px;
                    font-weight: bold;
                }

                #calendar-widget ::content .week .day { margin: 1px 1px 0 0; }

                    #calendar-widget ::content .calendar .month .day.highlighted { color: white; background-color: #90dca7; transition: all .3s ease-in-out }

                        #calendar-widget ::content .calendar .month .day.highlighted:hover { background-color: #52b972 }

                    #calendar-widget ::content .calendar .month .day.chosen { color: white; background-color: #29a54f }

                        #calendar-widget ::content .calendar .month .day.chosen:hover { background-color: #29a54f }

            ul.separated li {
                padding: 21px 0;
                border-bottom: 1px solid lightgrey;
            }

                ul.separated li:first-child {
                    border-top: 1px solid lightgrey;
                }

                ul.separated input[type=radio] {
                    min-height: 13px;
                    width: 13px;
                    height: 13px;
                    padding: 0;
                    margin:0;
                    vertical-align: text-bottom;
                    position: relative;
                    top: -1px;
                    *overflow: hidden;
                }

            .info_box_img img {
                width: 29px!important;
                height: 29px!important;
            }

            span.price {
                color: #29a54f;
                font-weight: bold;
            }

            :host ::content #infobox-droppoint .dp-icon {
                padding-left: 0;
            }

            :host ::content #ddList .dp-icon {
                padding-left: 0;
            }
            
            @media (max-width: 1024px) {

                .cardList {
                    width: 680px;
                    margin: 0 auto;
                }

                #locateme {
                    width: 53px;
                    right: 10px;
                    bottom: 20px;
                    display: block;
                }

                #go-to-home-address {
                    width: 50px;
                    height: 50px;
                    right: 70px;
                    bottom: 23px;
                }

                    #go-to-home-address img {
                        margin: 5px 0 0 -5px
                    }
            }

            @media (max-width: 736px) {
                .cardList {
                    width: 100%;
                    height: 380px;
                    overflow-x: scroll;
                    overflow-y: hidden;
                    flex-direction: column;
                    display: -webkit-flex;
                    -webkit-box-align: center;
                    -webkit-box-direction: normal;
                    -webkit-box-orient: horizontal;
                    -webkit-flex-direction: column;
                    -webkit-flex-wrap: wrap;
                    -webkit-overflow-scrolling: touch;
                }

                    .droppoint-margin.gfs-checkout:nth-child(2n+1).gfs-checkout {
                        margin-right: 20px;
                    }

                #locateme {
                    width: 53px;
                    right: 10px;
                    bottom: 20px;
                    display: block;
                }
            }

            @media (max-width: 667px) {

                ul li label {
                    max-width: 90%;
                }

                #droppoint_overlay {
                    height: 400px;
                }

            }

            @media (max-width: 493px) {
                .header label h3 {
                    font-size: 21px;
                }

                .droppoint-margin:nth-child(2n+1) {
                    margin-right: 20px;
                }

                #locateme {
                    width: 53px;
                    right: 10px;
                    bottom: 20px;
                    display: block;
                }
            }

            @media (max-width: 475px) {
                .header label h3 {
                    font-size: 19px;
                }

                .droppoint-margin {
                    margin-right: 20px;
                }

                    .droppoint-margin:first-child {
                        margin-right: 0;
                    }
            }

            @media (max-width: 440px) {

                .header label h3 {
                    font-size: 16px;
                }
            }

            @media (max-width: 414px) {
                .header label {
                    max-width: 90%;
                    line-height: initial;
                    vertical-align: middle;
                }

                ul {
                    list-style-type: none;
                }

                    ul li input[type="radio"] {
                        display: inline-block;
                        vertical-align: middle
                    }

                    ul li label {
                        max-width: 90%;
                        vertical-align: middle
                    }

                .cardList {
                    height: 350px;
                }

                #droppointAddress.form-control {
                    width: 189px;
                }
            }

            @media (max-width: 375px) {
                ul.separated li {
                    font-size: 12px;
                }
            }
        </style>

        <iron-ajax id="ajaxPost"
                   method="POST"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handlePostResponse"
                   on-error="_handleError"
                   debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="ajaxPostPostcode"
                   method="POST"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handlePostPostcodeResponse"
                   debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="ajaxGet"
                   method="GET"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handleGetResponse"
                   on-error="_handleError"
                   timeout="10000"
                   debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="ajaxGetPostcode"
                   method="GET"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handleGetPostcodeResponse"
                   on-error="_handleError"
                   timeout="10000"
                   debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="ajaxPatch"
                   method="PATCH"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handlePatchResponse"
                   debounce-duration="300">
        </iron-ajax>

        <iron-ajax id="ajaxGetDroppoints"
                   method="GET"
                   handle-as="json"
                   content-type="application/json"
                   on-response="_handleGetDroppointsResponse"
                   debounce-duration="300">
        </iron-ajax>

        <map-region-manager id="regionManager"></map-region-manager>

        <div id="widgetContainer">
            <div class="header">
                <input name="deliveryTypePanel" id="standardDeliveriesOption" on-click="_toggleStandardDeliveryPanelCollapse" type="radio" value="{{defaultDelivery}}" />
                <label for="standardDeliveriesOption">
                    <h3>{{standardDeliveryTitle}}</h3>
                </label>
            </div>

            <iron-collapse id="standardDeliveryPanel">
                <div class="toggle-content">
                    <div id="standard-loading" class="loading"><paper-spinner active id="standard-spinner"></paper-spinner></div>
                    <ul class="separated">
                        <template is="dom-repeat" items="{{standardRates}}" sort="sortServices">
                            <li class="gfsStd">
                                <input name="shipping_method" on-click="updateDeliveryOptions" type="radio" checked="{{item.selected}}" value="{{item.id}}" id="{{item.id}}" class="radio standard-delivery-selection" />
                                <label for$="{{item.id}}">
                                    <span class="methodname">{{item.methodTitle}}</span>
                                    <span class="price">{{currencySymbol}}{{item.price}}</span>
                                    <span>{{item.deliveryDateRange}}</span>
                                </label>
                            </li>
                        </template>
                    </ul>
                </div>
            </iron-collapse>

            <div class="header">
                <input name="deliveryTypePanel" id="calendarDeliveriesOption" on-click="_toggleCalendarPanelCollapse" type="radio" value="{{defaultDelivery}}" />
                <label for="calendarDeliveriesOption">
                    <h3>{{calendarDeliveryTitle}}</h3>
                </label>
            </div>

            <iron-collapse id="calendarPanel">

                <template is="dom-if" if="{{useCalendar}}">

                    <div id="calendar-loading" class="loading">
                        <paper-spinner active id="calendar-spinner"></paper-spinner>
                    </div>

                    <div class="row">
                        <div>
                            <brick-calendar id="calendar-widget" class="gfs-checkout hidden" controls first-weekday-num=0></brick-calendar>
                            <!-- Clicking on a day in the calendar sets _selectedDayDeliveries -->
                        </div>
                        <div>
                            <div id="calendar-delivery-options" class="hidden">
                                <h4>{{calendarDayPrompt}}</h4>
                                <ul class="separated">
                                    <template is="dom-repeat" items="{{_selectedDayDeliveries}}" sort="sortDayDefiniteServices">

                                        <li class="delivery-place">
                                            <input type="radio"
                                                   name="shipping_method"
                                                   value="{{item.id}}"
                                                   id="{{item.id}}"
                                                   checked="{{item.selected}}"
                                                   on-click="updateDeliveryOptions"
                                                   class="radio calendar-delivery-selection" />
                                            <label for$="{{item.id}}">
                                                <span class="gfsmethodname">
                                                    {{item.methodTitle}}
                                                    <span class="price">{{currencySymbol}}{{item.price}}</span>
                                                </span>
                                            </label>
                                        </li>

                                    </template>
                                </ul>
                            </div>
                        </div>
                    </div>
                </template>
            </iron-collapse>

            <div class="header">
                <input name="deliveryTypePanel" id="dropPointDeliveriesOption" on-click="_toggleDropPointPanelCollapse" type="radio" value="{{defaultDelivery}}" />
                <label for="dropPointDeliveriesOption">
                    <h3>{{dropPointTitle}}</h3>
                </label>
            </div>
            <iron-collapse id="dropPointPanel" opened="{{_droppointOpened}}">

                <div id="toggleDropPointsViewControls">
                    <div class="toggle-label">List <i class="fa fa-ellipsis-v"></i></div>
                    <paper-toggle-button id="toggleDropPointsView" class="gfs-toggle" on-change="_showDropPointsView" active="true" checked></paper-toggle-button>
                    <div class="toggle-label"><i class="fa fa-map-marker"></i> Map</div>
                </div>

                <div class="gfsDropPoint" id="mapContainer">
                    <div class="search-postcode-wrap">
                        <input type="text" id="droppointAddress" class="form-control" placeholder="Find alternative postcode" />
                        <input type="submit" name="findPostcode" id="droppointSubmit" class="btn btn-default" on-click="_findPostcode" value="Find" />
                        <input type="hidden" id="homePostcode" value="" />

                        <div id="go-to-home-address" class="btn btn-default" on-click="_goToHome">
                            <img src="/bower_components/gfs-checkout-widget/images/home.png" isHome="true" />
                        </div>
                        <div id="wrongPostoce"></div>
                    </div>

                    <div id="dropPointDetails" class$="{{_dropPointDetailsClass}}">
                        <div id="droppoint_overlay" style="height: {{mapHeight}}px; display: block">
                            <div id="droppoint_overlay_close" on-click="_hideDropPointDetails">
                                <img src="/bower_components/gfs-checkout-widget/images/x.png" alt="close" />
                            </div>
                            <gfs-droppoint id="overlay-droppoint" droppoint-data="{{_selectedDropPoint}}" container-class="overlay" show-distance="false" show-opening-hours="true"></gfs-droppoint>
                        </div>
                    </div>
                    <div class="hidden">
                        <div id="droppoint_info" on-click="_showDropPointDetails">
                            <gfs-droppoint id="infobox-droppoint" droppoint-data="{{_selectedDropPoint}}" button-type="tick"></gfs-droppoint>
                            <div id="droppoint_detail_link">
                                <a class="droppoint_info"> View Opening Times </a>
                            </div>
                        </div>
                    </div>

                    <div class="locateme-wrap">
                        <img id='locateme' on-click="_locateMe" src='/bower_components/gfs-checkout-widget/images/locateme.png' />
                    </div>

                    <div id="gfsMapCanvas">
                        <div class="loading">
                            <paper-spinner active id="map-spinner"></paper-spinner>
                        </div>
                    </div>
                </div>


                <array-selector id="dropPointSelector" items="{{_dropPoints}}" selected="{{chosen}}" multi="false"></array-selector>
                <div id="dropPointListContainer" class="hidden">
                    <h4>Drop Points</h4>
                    <div class="cardList">
                        <div id="list-loading" class="loading">
                            <paper-spinner active id="list-spinner"></paper-spinner>
                        </div>
                        <template id="dropPointList" is="dom-repeat" items="{{_dropPoints}}" sort="sortByDistance">
                            <gfs-droppoint id="ddList" show-opening-hours="true" container-class="dp-card" button-type="standard" droppoint-data="{{item}}" class="droppoint-margin"></gfs-droppoint>
                        </template>
                    </div>
                </div>
                <div>
                    <div id="droppoint-delivery-options">
                        <h4>{{dropPointDeliveryTitle}}</h4>
                        <ul class="separated">
                            <template is="dom-repeat" items="{{_selectedDroppoints}}" sort="sortServices">

                                <li class="delivery-place">
                                    <input type="radio"
                                           name="shipping_method"
                                           value="{{item.id}}"
                                           id="{{item.id}}"
                                           on-click="updateDeliveryOptions"
                                           class="radio droppoint-delivery-selection" />
                                <label for$="{{item.id}}">
                                    <span class="gfsmethodname">{{item.methodTitle}}</span>
                                    <span class="price">{{currencySymbol}}{{item.price}}</span>
                                    <span>{{item.deliveryDateRange}}</span>
                                </label>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>
            </iron-collapse>
        </div>
        <input type="text" value="{{_selectedDropPoint.droppointId}}" id="dropPointRadio" class="hidden" />
        <paper-toast id="errorNotification" class="fit-bottom"></paper-toast>
    </template>

    <script>
        var DAY_MS = 1000 * 60 * 60 * 24;
        var DOW_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun', '?'];
        var MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var geocoder = null;
        var marker = null;
        var previousPosition = [];
        var markers = []; 

        Polymer({
            is: "gfs-checkout",

            // add properties and methods on the element's prototype

            properties: {
               
                accessToken: {
                    type: String
                },

                currencySymbol: {
                    type: String,
                    value: '$'
                },

                gfsData: {
                    type: String
                },

                useDropPoints: {
                    type: Object,
                    value: true
                },

                useStandard: {
                    type: Object,
                    value: true
                },

                useCalendar: {
                    type: Object,
                    value: true
                },

                calendarLabels: {
                    type: Object,
                    value: {
                        //prev: "<<",
                        //next: ">>",
                        months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                        weekdays: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"]
                    }
                },

                allowCalendarPreselect: {
                    type: Object,
                    value: true
                },

                initialAddress: {
                    type: String
                },

                // ATTRIBUTES
                //
                // These properties represent text used for labels, titles and prompts throughout the widget.
                // They are controlled by passing values via the element attributes.
                // To override the default values shown below, simply pass through the attributes name, with camel caps converted to dashed lower case:
                // e.g: 'dropPointTitle' would be set by:
                // <gfs-checkout drop-point-title="Your text goes here"></gfs-checkout>

                dropPointTitle: {
                    type: String,
                    value: 'Collect your order'
                },

                dropPointDeliveryTitle: {
                    type: String,
                    value: 'Select your preferred collection point to view available services:'
                },

                calendarDeliveryTitle: {
                    type: String,
                    value: 'Choose a delivery date and time'
                },

                calendarDayPrompt: {
                    type: String,
                    value: 'Please select a delivery time:'
                },

                standardDeliveryTitle: {
                    type: String,
                    value: 'Standard delivery'
                },

                // Change the value of the default-delivery where the <gfs-checkout> element is loaded: default-delivery="your_option_here"
                // set default delivery option => Standard, Express or CollectionPoint
                defaultDelivery: {
                    type: String,
                    value: 'Standard'
                },

                hideMapUI: {
                    type: Object,
                    value: false
                },

                mapHeight: {
                    type: Number,
                    value: 400
                },

                homeIcon: {
                    type: String
                },

                startingZoomLevel: {
                    type: Number,
                    value: 14
                },

                //cheapestFirst, fastestFirst, expensiveFirst, slowestFirst
                serviceSortOrder: {
                    type: String,
                    value: "cheapestFirst"
                },

                // set default service parameters when API is not available
                defaultService: {
                    type: String,
                    value: ""
                },

                defaultCarrier: {
                    type: String,
                    value: ""
                },

                defaultPrice: {
                    type: String,
                    value: ""
                },

                defaultMinDeliveryTime: {
                    type: String,
                    value: ""
                },

                defaultMaxDeliveryTime: {
                    type: String,
                    value: ""
                },

                defaultCarrierCode: {
                    type: String,
                    value: ""
                },

                markerAmimation: {
                    type: String,
                    value: false
                },

                selectedServiceDetails: {
                    type: Object,
                    value: {
                        service: null,
                        shipping: null,
                        deliveryAddress: null,
                        expDeliveryDateStart: null,
                        expDeliveryDateEnd: null,
                        collectPoint: null,
                        serviceType: null,
                        selectedDeliveryOptionID: null,
                        selectedDropopintId: null,
                        sessionId: null
                    }
                },

                closeCheckout: {
                    type: Object,
                    value: {
                        closeSession: true,
                        selectedDeliveryOptionID: null,
                        selectedDroppointId: null
                    }
                },

                closeCheckoutError: {
                    type: Object,
                    value: {
                        error: true,
                        message: "Please select a service"
                    }
                },

                // keep the data for closeCheckout
                checkoutResults: {
                    type: String,
                    value: null
                },

                sessionid: {
                    type: String,
                    value: null
                },

                // PRIVATE PROPERTIES
                //
                // Do not modify these properties.

                _endPoint: {
                    type: String,
                    readOnly: true,
                    value: "//rest.api.checkout.justshoutgfs.com/api/CheckoutSession/"
                },

                _droppointOpened: {
                    type: Boolean,
                    value: false
                },

                _selectedDropPoint: {
                    type: Object
                },

                _dropPointDetailsClass: {
                    type: String,
                    value: "hidden"
                },

                _shippingRateGroups: {
                    type: Array,
                    notify: true,
                    value: []
                },

                _data: {
                    type: Object,
                    value: {
                        dayDefinite: [],
                        droppoints: [],
                        standardRates: [],
                        links: [],
                        nonDayDefinite: []
                    }
                },

                _dropPoints: {
                    type: Array,
                    notify: true
                },

                _map: {
                    type: Object
                },

                _currentMarker: {
                    type: Object
                },

                _infoWindow: {
                    type: Object
                },

                //Lookup for deliveries on a given day
                _deliveryDays: {
                    type: Object,
                    value: {}
                },

                //Lookup for deliveries on a given day
                _deliveryDroppoints: {
                    type: Object,
                    value: {}
                },

                _earliestDelivery: {
                    type: Object,
                    value: null
                },

                _infoBoxDroppoint: {
                    type: Object
                }
            },

            listeners: {
                "datetoggleon": "_deliveryDateSelected",
                "prevmonth": "_calendarMonthChanged",
                "nextmonth": "_calendarMonthChanged",
                "droppoint-changed": "_droppointChanged"
            },

            observers: [
                'droppointOpenChanged(_droppointOpened)'
            ],
            
            sortByDistance: function (a, b) {
                if (a === b) return 0;
                return a.distanceInMeters < b.distanceInMeters ? -1 : 1;
            },

            sortServices: function (a, b) {
                if (a == b) return 0;

                switch (this.serviceSortOrder) {
                    case "cheapestFirst":
                        return a.price < b.price ? -1 : 1;
                    case "fastestFirst":
                        return a.deliveryTimeFrom < b.deliveryTimeFrom ? -1 : 1;
                    case "expensiveFirst":
                        return a.price > b.price ? -1 : 1;
                    case "slowestFirst":
                        return a.deliveryTimeFrom > b.deliveryTimeFrom ? -1 : 1;
                    default:
                        return;
                }
            },

            sortDayDefiniteServices: function (a, b) {
                if (a == b) return 0;

                switch (this.serviceSortOrder) {
                    case "expensiveFirst":
                        return a.price > b.price ? -1 : 1;
                    case "cheapestFirst":
                    case "fastestFirst":
                    case "slowestFirst":
                    default:
                        return a.price < b.price ? -1 : 1;
                }
            },

            droppointOpenChanged: function(_droppointOpened) {
                if (this._selectedDropPoint) {
                    this.set('_selectedDropPoint.chosen', _droppointOpened);
                    this.fire("droppoint-changed", this._selectedDropPoint);
                }
            },

            _computeHeader: function() {
                return {
                    "Authorization": "Bearer " + atob(this.accessToken)
                };
            },

            // This function is called as soon as the widget is ready
            ready: function() {
                var theJson = atob(this.gfsData);
                theJson = theJson.replace(/\r?\n|\r/g, "");
                actualPost = JSON.parse(theJson);

                console.log("gfsData ", this.gfsData);

                // keep original home postcode
                this.$.homePostcode.value = actualPost.Request.Order.Transit.Recipient.Location.Postcode;
                this.$$(".search-postcode-wrap").classList.add('hidden');

                if (this.accessToken === "") {
                    this.$.errorNotification.text = "No Access Token.. ";
                    this.$.errorNotification.duration = 8000;
                    this.$.errorNotification.show();
                } else {
                    this.$.ajaxPost.url = this._endPoint;
                    this.$.ajaxPost.body = actualPost;
                    console.log("Initial POST", new Date().getTime());
                    this.$.ajaxPost.headers = this._computeHeader();
                    this.$.ajaxPost.generateRequest();

                    if (this.defaultDelivery === '') { // set Standard delivery if none is supplied
                        this.defaultDelivery = 'Standard';
                    }

                    // check which is the default delivery option
                    switch (this.defaultDelivery) {
                        case 'Standard':
                            return this.$.standardDeliveryPanel.opened = true;
                        case 'Express':
                            return this.$.calendarPanel.opened = true;
                        case 'CollectionPoint':
                            return this.$.dropPointPanel.opened = true;
                    }
                }
            },

            _handlePostResponse: function(e) {
                console.log("Followup GET", new Date().getTime());
                this._sessionId = e.detail.response.substring(e.detail.response.lastIndexOf("/") + 1);
                this.$.ajaxGet.url = this._endPoint + this._sessionId;
                this.$.ajaxGet.headers = this._computeHeader();

                console.log('sessionID', this._sessionId);
                this.$.ajaxGet.generateRequest();
            },

            // search for a new post code and keep the sessionID
            _handlePostPostcodeResponse: function (e) {
                this.$.ajaxGetPostcode.url = this._endPoint + this._sessionId;
                this.$.ajaxGetPostcode.headers = this._computeHeader();
                this.$.ajaxGetPostcode.generateRequest();
            },

            _handleGetResponse: function(e) {
                this.$$('#list-spinner').active = false;
                this.$$('#list-loading').classList.add('hidden');
                this.$$('#standard-loading').classList.add('hidden');

                if (this.useCalendar) {
                    this.$$('brick-calendar').classList.remove('hidden');
                    this.$$('#calendar-loading').classList.add('hidden');
                    this.$$('#calendar-delivery-options').classList.remove('hidden');
                };  

                this.$$(".search-postcode-wrap").classList.add('hidden');

                if (this.$$("#map-spinner")) {
                    this.$$("#map-spinner").classList.add('hidden');
                }

                this.countryCode = actualPost.Request.Order.Transit.Recipient.Location.CountryCode.Code;
                this.postCode = actualPost.Request.Order.Transit.Recipient.Location.Postcode;

                var useWebService = true; //false;
                if (useWebService) {
                    this._data = e.detail.response;
                }
                else if (typeof (this.gfsData) === "string") {
                    var unencoded = atob(this.gfsData);
                    this._data = JSON.parse(unencoded);
                }
                // load droppoints
                this._dropPoints = this._data.droppoints;

                window.setTimeout(this._delayedInit.bind(this), 0);
            },

            // return the new droppoints
            _handleGetPostcodeResponse: function (e) {
                this.countryCode = actualPost.Request.Order.Transit.Recipient.Location.CountryCode.Code;
                this.postCode = actualPost.Request.Order.Transit.Recipient.Location.Postcode;

                var curDroppoints = this._dropPoints;
                var newDroppoints = e.detail.response.droppoints;

                this._dropPoints = this._removeDuplicateDropPoints(this._dropPoints.concat(newDroppoints));
                this._loadDroppointMarkers(this._dropPoints);
                this._findAllDeliveryDroppoints();
            },

            _removeDuplicateDropPoints: function (droppoints) {
                var a = droppoints.concat();

                for (var i = 0; i < a.length; ++i) {
                    for (var j = i + 1; j < a.length; ++j) {
                        if (a[i].droppointId === a[j].droppointId) {
                            a.splice(j--, 1);
                        }
                    }
                }
                return a;
            },

            _handleError: function(e) {
                // hide all services except standard
                this.$$("#calendarDeliveriesOption").parentNode.classList.add("hidden");
                this.$$("#dropPointDeliveriesOption").parentNode.classList.add("hidden");

                this.$$('#standard-loading').classList.add('hidden');
                this.$.standardDeliveriesOption.checked = "checked";
                this.defaultDelivery = "Standard";
                this.$.standardDeliveryPanel.opened = true;
                this.$.calendarPanel.opened = false;
                this.$.dropPointPanel.opened = false;
                this._noServices();
            },

            _handlePatchResponse: function (e) {
                // close no matter what, can't hold the order up because of api issues
                this.fire("close-checkout-complete", e.detail.response);
            },

            _handleGetDroppointsResponse: function(e) {
                // assign the new data.
                this._data = e.detail.response;
                if (!this._dropPoints)
                    this._dropPoints = [];
                this._dropPoints = this._dropPoints.concat(this._data.droppoints);
                this._findAllDeliveryDroppoints();
                this._loadDroppointMarkers(this._data.droppoints);
            },

            _delayedInit: function() {
                console.log("_delayedInit", new Date().getTime());
                this._processInputData();

                if (this.useDropPoints) {
                    if (this.defaultDelivery === 'CollectionPoint') {
                        this.$$(".search-postcode-wrap").classList.remove('hidden');
                        this.$$("#droppoint-delivery-options").classList.remove('hidden');
                    }
                    this._makeMap();
                    this._loadDroppointMarkers(this._dropPoints);
                    // sort droppoint data
                    this._findAllDeliveryDroppoints();
                }
                if (this.useCalendar) {
                    this._makeCalendar();
                }

                this._checkForServices(this.defaultDelivery);

                console.log("_delayedInit end", new Date().getTime());
            },

            _apiKeyChanged: function(newValue, oldValue) {
                console.log('API Key changed to', newValue);
            },

            _processInputData: function () {
                this._processNonDayDefiniteData();
            },

            _checkForServices: function (defaultDelivery) {
                if ((defaultDelivery === 'Standard') && (this._data.standardRates.length !== 0)) {
                    this.$.standardDeliveriesOption.checked = "checked";
                    this.$.standardDeliveryPanel.opened = true;
                    this._preselectForStandard();
                }
                else if (this._data.standardRates.length === 0) {
                    this.$.standardDeliveryPanel.opened = false;
                    this.$$("#standardDeliveriesOption").parentNode.classList.add("hidden");
                }

                if (((defaultDelivery === 'Express') || (this._data.standardRates.length === 0)) && (this._data.dayDefinite.length !== 0)) {
                    this.$.calendarDeliveriesOption.checked = "checked";
                    this.$.calendarPanel.opened = true;
                    this._preselectForExpress();
                }
                else if ((this._data.dayDefinite.length === 0) || (this.useCalendar === false))  {
                    this.$.calendarPanel.opened = false;
                    this.$$("#calendarDeliveriesOption").parentNode.classList.add("hidden");
                }

                var deliveryDroppointsSize = Object.keys(this._deliveryDroppoints).length;
                if ((defaultDelivery === 'CollectionPoint') && (deliveryDroppointsSize !== 0)) {
                    this.$.dropPointDeliveriesOption.checked = "checked";
                    this.$.dropPointPanel.opened = true;
                }
                else if (deliveryDroppointsSize === 0) {
                    this.$$("#dropPointDeliveriesOption").parentNode.classList.add("hidden");
                }

                // if we don't have services set a default one
                if ((this._data.standardRates.length === 0) && (this._data.dayDefinite.length === 0) && (deliveryDroppointsSize === 0)) {
                    this.$$("#standardDeliveriesOption").parentNode.classList.remove("hidden");
                    this.$.standardDeliveriesOption.checked = "checked";
                    this.$.standardDeliveryPanel.opened = true;
                    this.$.errorNotification.text = "No services configured"
                    this.$.errorNotification.duration = 8000;
                    this.$.errorNotification.open();
                    this._noServices();
                }
            },

            // find the earliest of each service
            _getGroupedByService: function() {
                var self = this;
                var results = [];
                var services = [];

                // find the earliest of each non day definite service
                this._data.nonDayDefinite.forEach(function(day) {
                    day.rates.forEach(function(service) {
                        if (service.serviceType.type === "dmStandard") {
                            if (typeof(services[service.methodTitle]) === "undefined") {
                                services[service.methodTitle] = {
                                    deliveryDate: day.deliveryDate,
                                    service: service
                                };
                            } else {
                                var servicesDay = new Date(services[service.methodTitle].deliveryDate)
                                var nonDayDefiniteDay = new Date(day.deliveryDate);
                                if (servicesDay.getTime() > nonDayDefiniteDay.getTime())
                                    services[service.methodTitle] = {
                                        deliveryDate: day.deliveryDate,
                                        service: service
                                    };
                            }
                        }
                    });
                });

                // create array for display in polymer
                for (var service in services) {
                    var item = services[service];
                    var obj = {
                        id: item.service.id,
                        methodTitle: item.service.methodTitle,
                        price: item.service.price,
                    };
                    // non day definite
                    var startDate = new Date(item.deliveryDate);
                    var endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (item.service.maxDD - item.service.minDD));
                    obj.deliveryDateRange = this._formatNonDayDefiniteDate(startDate, endDate);
                    obj.deliveryTimeFrom = endDate.getTime();
                    results.push(obj);
                }
                return results;
            },

            _getDeliveryRateById: function(id) {
                var combinedRateGroups = this._data.dayDefinite.concat(this._data.nonDayDefinite);
                var rates = [];
                combinedRateGroups.forEach(function(group) {
                    rates = rates.concat(group.rates);
                });
                var resultList = rates.filter(function(rate) {
                    return rate.id == id
                });
                if (resultList.length) {
                    if (this.$.calendarDeliveriesOption.checked === true) {
                        for (var i = 0; i < resultList.length; i++) {
                            if ((moment(resultList[i].deliveryTimeTo).format("YYYY-MM-DD")) === moment(this.$$('brick-calendar').chosen).format("YYYY-MM-DD")) {
                                return resultList[i];
                            }
                        }
                    }
                    else {
                        return resultList[0];
                    }
                } else return null;
            },

            _processNonDayDefiniteData: function() {
                if (this._data.nonDayDefinite.constructor === Array && this._data.nonDayDefinite.length > 0) {
                    this._data.standardRates = this._getGroupedByService();
                    this.standardRates = this._data.standardRates;
                }
                else { // usefull for _checkForServices
                    this.standardRates = [];
                    this._data.standardRates = this.standardRates;
                }
            },

            _forceArray: function(o) {
                return ((o.constructor !== Array) ? [o] : o);
            },

            _makeCalendar: function() {
                this.$$('brick-calendar').labels = this.calendarLabels;
                this._findAllDeliveryDays();
                window.setTimeout(this._markDeliveryDays.bind(this), 500);
            },

            _makeMap: function() {
                var self = this;

                var home = null;
                //var geocoder = null;

                //self._infoBoxDroppoint = self.$$('#infobox-droppoint');
                self._infoWindow = new google.maps.InfoWindow({
                    content: self.$.droppoint_info
                });

                // map options
                var mapOptions = {

                    // initial zoom level
                    zoom: self.startingZoomLevel,
                    minZoom: self.startingZoomLevel - 2,

                    // initial center position
                    //center: position,

                    // type of map (ROADMAP, SATELLITE, TERRAIN, HYBRID)
                    mapTypeId: google.maps.MapTypeId.TERRAIN,

                    // show or hide streetview control
                    streetViewControl: false,

                    // show or hide the google map UI
                    disableDefaultUI: self.hideMapUI,

                    // map controls (only if disableDefaultUI is false)
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                        position: google.maps.ControlPosition.TOP_RIGHT,
                    },

                    zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.SMALL,
                        position: google.maps.ControlPosition.TOP_RIGHT
                    },

                    // remove points of interest from the map so as not to interfere
                    styles: [{
                        "featureType": "poi",
                        "elementType": "labels",
                        "stylers": [{
                            "visibility": "off"
                        }]
                    }]
                };

                self._map = new google.maps.Map(self.$.gfsMapCanvas, mapOptions);

                //=== Home marker
                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    componentRestrictions: {
                        country: this.countryCode,
                        postalCode: this.postCode
                    }
                }, function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        var homeMarkerConfig = {
                            position: results[0].geometry.location,
                            map: self._map,
                            animation: google.maps.Animation.DROP,
                            title: 'Home',
                            html: 'Home',
                            icon: self._getHomeIcon()
                        };
                        marker = new google.maps.Marker(homeMarkerConfig);
                        self._map.setCenter(homeMarkerConfig.position);

                        var getPreviousPos = Object.keys(previousPosition).length;
                        if (getPreviousPos > 0) {
                            self._map.panTo(previousPosition);
                        }

                    } else {
                        console.log('Google Maps API ERROR - Geocode was not successful for the following reason: ' + status);
                        $("#gfsMapCanvas").append("<div style='color: #d60000; margin: 20px auto; text-align: center;'> Postcode <strong>" + self.initialAddress + "</strong> return zero restults </div>");
                    }
                });
            },

            _clearMarkers: function (markers) {
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(self._map);
                }
            },

            _loadDroppointMarkers: function (dropPointsArray) {
                var self = this;
                  //=== Drop point markers
                var marker;

                dropPointsArray.forEach(
                    function (pointItem) {
                        var getCountryCode = pointItem.geoLocation.countryCode;
                        var markerConfig = {
                            position: new google.maps.LatLng(pointItem.geoLocation.coordinates.latitude, pointItem.geoLocation.coordinates.longitude),
                            map: self._map,
                            animation: google.maps.Animation.DROP,
                            title: pointItem.droppointDescription,
                            customData: pointItem,
                            icon: self._droppointIcon(getCountryCode) + '/' + pointItem.providerName + '.png',
                            zIndex: google.maps.Marker.MAX_ZINDEX + 1
                        };
                        //console.log(pointItem.geoLocation.coordinates.longitude, pointItem.geoLocation.coordinates.latitude);
                        marker = new google.maps.Marker(markerConfig);
                        markers.push(marker);
                        marker.addListener('click', function (clickedMarker) {
                            self._selectDropPoint(this);
                        });
                        // add a link to the marker to get to it from the droppoint, need to animate and centre the marker if selecting from list view
                        pointItem.marker = marker;
                    }
                );

                google.maps.event.addListener(self._map, 'click', function(event) {
                    self._unselectDropPoint();
                    // self.fire('hide-collectionInfo');
                });
            },

            _droppointIcon: function(countryCode) {
                var url = this.resolveUrl('/bower_components/gfs-checkout-widget/images/');

                switch (countryCode) {
                    case "DE":
                        return url + '/DE/';
                    case "FR":
                    case "BE":
                    case "ES":
                        return url + '/FR/';
                    default:
                        return url + '/GB/';
                }
            },

            _returnPostcode: function () {
                var self = this;
                var postcode = self.$.droppointAddress.value
                var emptyPostcode = new RegExp(/^\s\s*/);

                if (postcode === "" || postcode.match(emptyPostcode)) {
                    self.$.errorNotification.text = "Please enter a valid postcode";
                    self.$.errorNotification.fitInto = self.$.gfsMapCanvas;
                    this.$.errorNotification.duration = 5000;
                    self.$.errorNotification.open();
                    return;
                }

                if (!!markers) {
                    this._clearMarkers(markers);
                }

                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    componentRestrictions: {
                        country: this.countryCode,
                        postalCode: postcode
                    }
                }, function (results, status) {
                    self.initialAddress = postcode; // set the delivery address to the new one
                    if (status == google.maps.GeocoderStatus.OK) {
                        var position = results[0].geometry.location;
                        self._map.setCenter(position);
                        self.$.ajaxPostPostcode.headers = self._computeHeader();
                        self.$.ajaxPostPostcode.url = self._endPoint;
                        self.$.ajaxPostPostcode.body = self.$.ajaxPost.body;
                        self.$.ajaxPostPostcode.body.Request.Session.sessionID = self._sessionId;
                        self.$.ajaxPostPostcode.body.Request.Order.Transit.Recipient.Location.Postcode = postcode;
                        self.$.ajaxPostPostcode.generateRequest();
                    }
                    else {
                        console.log('Google Maps API ERROR - Geocode was not successful for the following reason: ' + status);
                        self.$.errorNotification.text = "Postcode not found in " + self.countryCode;
                        self.$.errorNotification.fitInto = self.$.gfsMapCanvas;
                        this.$.errorNotification.duration = 5000;
                        self.$.errorNotification.open();
                        return;
                    }
                });

            },

            _geoCoder: function(postcode) {
                var self = this;
                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    componentRestrictions: {
                        country: this.countryCode,
                        postalCode: postcode
                    }
                }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        self._map.setCenter(results[0].geometry.location);
                    }

                    else {
                        console.log('Google Maps API ERROR - Geocode was not successful for the following reason: ' + status);
                        self.$.errorNotification.text = "Postcode not found in " + self.countryCode;
                        self.$.errorNotification.fitInto = self.$.gfsMapCanvas;
                        this.$.errorNotification.duration = 5000;
                        self.$.errorNotification.open();
                    }
                });
            },

            _findPostcode: function (e) {
                e.preventDefault();
                var self = this;
                self.fire('hide-collectionInfo');

                var postcode = self.$.droppointAddress.value
                self._returnPostcode(postcode);
            },

            _goToHome: function(e) {
                e.preventDefault();
                var self = this;
                self.fire('hide-collectionInfo');

                var homePostcode = self.$.homePostcode.value;
                self._geoCoder(homePostcode);
            },

            _showDropPointDetails: function() {
                this.mapHeight = this.$.gfsMapCanvas.clientHeight;
                this._dropPointDetailsClass = "fade-in";
            },

            _showDropPointsView: function() {
                if (this.$.toggleDropPointsView.checked) {
                    this.$.dropPointListContainer.classList.add('hidden');
                    this.$.mapContainer.classList.remove('hidden');
                    this._fixMapMarker();
                } else {
                    this.$.dropPointListContainer.classList.remove('hidden');
                    this.$.mapContainer.classList.add('hidden');
                }
            },

            _savePosition: function() {
                previousPosition = this._map.getCenter();
            },

            _hideDropPointDetails: function() {
                this._dropPointDetailsClass = "fade-out";
            },

            _getHomeIcon: function() {
                if (this.homeIcon) {
                    return this.homeIcon;
                } else {
                    return this.resolveUrl('/bower_components/gfs-checkout-widget/images/home.png');
                }
            },

            _selectDropPoint: function(marker) {
                marker.customData.chosen = true;
                this.fire("droppoint-changed", marker.customData);
            },

            _unselectDropPoint: function() {
                if (this._selectedDropPoint) {
                    this._selectedDropPoint.chosen = false;
                    if (this._currentMarker)
                        this._currentMarker.setAnimation(null);
                    if (this._infoWindow) {
                        this._infoWindow.close();
                    }
                    this._hideDropPointDetails();
                }
            },

            _fixMapMarker: function () {
                if (this.$.toggleDropPointsView.checked && !!this._selectedDropPoint) {
                    this._currentMarker = this._droppointById(this._selectedDropPoint.providerId, this._selectedDropPoint.droppointId).marker;

                    //if (this._selectedDropPoint.chosen === true) {
                    this._infoWindow.open(this._map, this._currentMarker);
                    //}

                    if (this.markerAmimation) {
                        this._currentMarker.setAnimation(google.maps.Animation.BOUNCE);
                    }

                    this.$.dropPointRadio.setAttribute('checked', 'true');
                    this._map.panTo(this._currentMarker.getPosition());
                }
            },

            _droppointChanged: function(e) {
                console.log('_droppointChanged', e.detail);
                var changedDroppoint = e.detail;

                // todo provider id needs to be in here as well
                if (this._selectedDropPoint)
                    if (changedDroppoint.droppointId !== this._selectedDropPoint.droppointId)
                        this._unselectDropPoint();

                this._selectedDropPoint = changedDroppoint;
                // find the marker for animation
                this._fixMapMarker();
                var deliveries = this._findDropPointDeliveries(this._selectedDropPoint.providerId);
                this._selectedDroppoints = deliveries;

                var droppointItems = Polymer.dom(this.root).querySelectorAll(".droppoint-delivery-selection");
                for (var i = 0; i < droppointItems.length; i++) {
                    droppointItems[i].checked = false;
                }
                this.fire("getDroppointSelectedService");
            },

            _droppointById: function(providerId, droppointId) {
                for (var i = 0; i < this._dropPoints.length; i++) {
                    if ((this._dropPoints[i].providerId === providerId) && (this._dropPoints[i].droppointId === droppointId)) {
                        return this._dropPoints[i];
                    }
                }
            },


            _locateMe: function() {
                var self = this;
                // Try HTML5 geolocation.
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            var pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            self._map.setCenter(pos);
                        },
                        function() {
                            handleLocationError(true, self._infoWindow, GMap.getCenter());
                        }
                    );
                } else {
                    // Browser doesn't support Geolocation
                    //handleLocationError(false, infoWindow, GMap.getCenter());
                }
            },

            _makeDateStr: function(d) {
                function pad(n, padSize) {
                    var str = n.toString();
                    var padZeros = (new Array(padSize)).join('0');
                    return (padZeros + str).substr(-padSize);
                }
                return (
                    pad(d.getFullYear(), 4) + '-' +
                    pad(d.getMonth() + 1, 2) + '-' +
                    pad(d.getDate(d), 2)
                );
            },

            _deliveryDateSelected: function(e) {
                var deliveries = this._findDayDefiniteDeliveries(e.detail.date);
                if (deliveries && deliveries.length > 0) {
                    this._selectedDayDeliveries = deliveries;
                } else {
                    this.$$('brick-calendar').chosen = [];
                }
                this.fire("getCalendarSelectedService");
            },

            _findDayDefiniteDeliveries: function(onDate) {
                var dateStr = this._makeDateStr(onDate);
                if (typeof(this._deliveryDays[dateStr]) !== "undefined") {
                    return this._deliveryDays[dateStr];
                } else {
                    return null;
                }

            },

            _formatDayDefiniteDate: function(deliveryDate) {
                return '(Est. arrival: ' + moment(deliveryDate).format("ddd, Do MMMM") + ')';
            },

            _formatNonDayDefiniteDate: function(startDate, endDate) {
                return '(Est. arrival: ' + moment(startDate).format("ddd, Do MMMM") + ' - ' + moment(endDate).format("ddd, Do MMMM") + ')';
            },

            _findDropPointDeliveries: function(providerId) {
                var self = this;
                var droppointIndex = providerId;
                if (typeof(this._deliveryDroppoints[droppointIndex]) !== "undefined") {
                    var results = [];
                    for (var service in this._deliveryDroppoints[droppointIndex]) {
                        var item = this._deliveryDroppoints[droppointIndex][service];
                        var obj = {
                            id: item.service.id,
                            methodTitle: item.service.methodTitle,
                            price: item.service.price,
                        };
                        if (item.service.maxDD == item.service.minDD) {
                            // day definite
                            var startDate = new Date(item.deliveryDate);
                            obj.deliveryDateRange = this._formatDayDefiniteDate(startDate);
                        } else {
                            // non day definite
                            var startDate = new Date(item.deliveryDate);
                            var endDate = new Date(startDate);
                            endDate.setDate(endDate.getDate() + (item.service.maxDD - 1));
                            obj.deliveryDateRange = this._formatNonDayDefiniteDate(startDate, endDate);
                        }
                        results.push(obj);
                    }
                    return results;
                } else {
                    return null;
                }
            },

            _processDeliveryArray: function(obj) {
                var self = this;
                obj.forEach(function(day) {
                    day.rates.forEach(function(service) {
                        if (service.serviceType.type === "dmStandardDropPoint") {
                            service.serviceType.droppointProviders.forEach(function(provider) {
                                if (typeof(self._deliveryDroppoints[provider.id]) === "undefined")
                                    self._deliveryDroppoints[provider.id] = [];
                                if (typeof(self._deliveryDroppoints[provider.id][service.methodTitle]) === "undefined") {
                                    self._deliveryDroppoints[provider.id][service.methodTitle] = {
                                        deliveryDate: day.deliveryDate,
                                        service: service
                                    };
                                } else {
                                    var objsDay = new Date(self._deliveryDroppoints[provider.id][service.methodTitle].deliveryDate);
                                    var droppointDay = new Date(day.deliveryDate);
                                    if (objsDay.getTime() > droppointDay.getTime())
                                    if (self._deliveryDroppoints[provider.id][service.methodTitle].deliveryDate < day.deliveryDate) {
                                        self._deliveryDroppoints[provider.id][service.methodTitle] = {
                                            deliveryDate: day.deliveryDate,
                                            service: service
                                        };
                                    }
                                }
                            });
                        }
                    });
                });
            },

            _findAllDeliveryDroppoints: function() {
                this._processDeliveryArray(this._data.dayDefinite);
                this._processDeliveryArray(this._data.nonDayDefinite);
            },

            _findAllDeliveryDays: function() {
                //Make an index of delivery days, dmStandard
                var self = this;
                this._data.dayDefinite.forEach(function(item) {
                    var dateStr = self._makeDateStr(new Date(item.deliveryDate));
                    var deliveryDate = new Date(dateStr);
                    item.dateStr = dateStr;

                    self._deliveryDays[dateStr] = item.rates.filter(function(rate) {
                        return (rate.serviceType.type === "dmStandard");
                    });

                    if ((self._earliestDelivery == null) || deliveryDate < self._earliestDelivery) {
                        self._earliestDelivery = self._deliveryDays[dateStr];
                    }
                });
            },

            _markDeliveryDays: function() {
                for (var dateStr in this._deliveryDays) {
                    var selector = 'brick-calendar .day[data-date="' + dateStr + '"]';

                    var results = document.querySelectorAll(selector);
                    if (results) {
                        for (var i = 0; i < results.length; i++) {
                            results[i].classList.add('highlighted');
                            results[i].classList.add('gfs-checkout');
                        }
                    }
                }
                if (this.$.calendarPanel.opened === true) {
                    this._preselectForExpress();
                }
            },

            _calendarMonthChanged: function(e) {
                this._markDeliveryDays();
            },

            _preselectForStandard: function() {
                var cheapestMethod = null;
                var preselectDay = false;
                var items = this._data.standardRates;
                items.forEach(function(carrier) {
                    if (cheapestMethod === null || (carrier.price < cheapestMethod.price)) {
                        cheapestMethod = carrier;
                    }
                });

                this._selectCheapestMethod(cheapestMethod);
            },

            _preselectForExpress: function () {
                var cheapestMethod = null;
                var preselectDay = false;

                if (this.allowCalendarPreselect) {
                    items = this._earliestDelivery;
                    items.forEach(function (item) {
                        if (cheapestMethod === null || (item.price < cheapestMethod.price)) {
                            cheapestMethod = item;
                            preselectDay = true;
                        }
                    });
                }

                if (cheapestMethod) {
                    if (preselectDay) {
                        this.$$('brick-calendar').chosen = [cheapestMethod.deliveryTimeFrom];
                        cheapestMethod.date = new Date(cheapestMethod.deliveryTimeFrom);
                        this.fire('datetoggleon', cheapestMethod);

                        if(this.defaultDelivery === 'Express')
                            this._selectCheapestMethod(cheapestMethod);
                    }
                }
            },

            _selectCheapestMethod: function (cheapestMethod) {
                cheapestMethod.selected = true;
                var method = this._getDeliveryRateById(cheapestMethod.id);
                this.selectedServiceDetails.serviceId = method.id;
                this.selectedServiceDetails.service = method.methodTitle;
                this.selectedServiceDetails.serviceCode = method.carrierCode;
                this.selectedServiceDetails.carrier = method.carrierName;
                this.selectedServiceDetails.shipping = method.price;
                this.selectedServiceDetails.expDeliveryDateStart = moment(method.deliveryTimeFrom).toISOString();
                this.selectedServiceDetails.expDeliveryDateEnd = moment(method.deliveryTimeTo).add(method.maxDD - method.minDD, 'days').toISOString();
                this.selectedServiceDetails.checked = cheapestMethod.selected;
                this.selectedServiceDetails.currencySymbol = this.currencySymbol;

                this.closeCheckout.selectedDeliveryOptionID = method.deliveryOptionId;

                if (this.$.dropPointDeliveriesOption.checked == true) {
                    this.selectedServiceDetails.collectionPoint = this._selectedDropPoint.droppointId;
                    this.selectedServiceDetails.deliveryAddress = this._selectedDropPoint.geoLocation;
                    this.closeCheckout.selectedDroppointId = this._selectedDropPoint.droppointId;
                }
                else {
                    this.selectedServiceDetails.selectedDropopintId = null;
                    this.closeCheckout.selectedDroppointId = null;
                }

                this.fire('selectedServiceChanged', this.selectedServiceDetails);
                this.fire("getStandardSelectedService", this.selectedServiceDetails);

                var checkoutResultsData = document.getElementById(this.checkoutResults);
                if (!!checkoutResultsData) {
                    checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                }
                var sessionID = document.getElementById(this.sessionid);
                if (!!sessionID) {
                    sessionID.value = btoa(this._sessionId);
                }
            },

            _toggleCollapse: function(id) {
                //If I am open, close everyone
                //If I am closed, open me and close everyone
                var self = this;
                var myElement = this.$$('#' + id);
                var collapseElements = Polymer.dom(this.root).querySelectorAll('iron-collapse');
                var myState = myElement.opened;
                collapseElements.forEach(function(item) {
                    item.opened = false;
                });
                myElement.opened = !myState;

                google.maps.event.trigger(self._map, 'resize');
            },

            _toggleCalendarPanelCollapse: function (e) {
                this._toggleCollapse('calendarPanel');
                
                var checkoutResultsData = document.getElementById(this.checkoutResults);
                if (!!checkoutResultsData) {
                    checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                }

                // if a service is selected disable it
                var standardItems = Polymer.dom(this.root).querySelectorAll(".standard-delivery-selection");
                for (var i = 0; i < standardItems.length; i++) {
                    standardItems[i].checked = false;
                }

                var calendarItems = Polymer.dom(this.root).querySelectorAll(".calendar-delivery-selection");
                for (var i = 0; i < calendarItems.length; i++) {
                    calendarItems[i].checked = false;
                }

                var droppointItems = Polymer.dom(this.root).querySelectorAll("droppoint-delivery-selection");
                for (var i = 0; i < droppointItems.length; i++) {
                    droppointItems[i].checked = false;
                }

                // open available services
                this._preselectForExpress();

                // reset selected service
                this.fire("getStandardSelectedService");
                this.fire("getCalendarSelectedService");
                this.fire("getDroppointSelectedService");
            },

            _toggleDropPointPanelCollapse: function (e) {
                this._toggleCollapse('dropPointPanel');
                this.$$(".search-postcode-wrap").classList.remove('hidden');
                this.$$("#droppoint-delivery-options").classList.remove('hidden');
                
                var checkoutResultsData = document.getElementById(this.checkoutResults);
                if (!!checkoutResultsData) {
                    checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                }

                var standardItems = Polymer.dom(this.root).querySelectorAll(".standard-delivery-selection");
                for (var i = 0; i < standardItems.length; i++) {
                    standardItems[i].checked = false;
                }

                var calendarItems = Polymer.dom(this.root).querySelectorAll(".calendar-delivery-selection");
                for (var i = 0; i < calendarItems.length; i++) {
                    calendarItems[i].checked = false;
                }

                var droppointItems = Polymer.dom(this.root).querySelectorAll(".droppoint-delivery-selection");
                for (var i = 0; i < droppointItems.length; i++) {
                    droppointItems[i].checked = false;
                }

                this.fire("getStandardSelectedService");
                this.fire("getCalendarSelectedService");
                this.fire("getDroppointSelectedService");

                if (this.$.dropPointPanel.opened === true) {
                    this._fixMapMarker();
                    if(!!this._selectedDropPoint) {
                        this.fire("droppoint-changed", this._selectedDropPoint);
                    }
                    var self = this;
                    google.maps.event.trigger(self._map, 'resize');
                    window.setTimeout(self._map.panTo(marker.position), 100);
                }
            },

            _toggleStandardDeliveryPanelCollapse: function (e) {
                this._toggleCollapse('standardDeliveryPanel');
                
                var checkoutResultsData = document.getElementById(this.checkoutResults);
                if (!!checkoutResultsData) {
                    checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                }

                var standardItems = Polymer.dom(this.root).querySelectorAll(".standard-delivery-selection");
                for (var i = 0; i < standardItems.length; i++) {
                    standardItems[i].checked = false;
                }

                var calendarItems = Polymer.dom(this.root).querySelectorAll(".calendar-delivery-selection");
                for (var i = 0; i < calendarItems.length; i++) {
                    calendarItems[i].checked = false;
                }

                var droppointItems = Polymer.dom(this.root).querySelectorAll(".droppoint-delivery-selection");
                for (var i = 0; i < droppointItems.length; i++) {
                    droppointItems[i].checked = false;
                }

                this.fire("getStandardSelectedService");
                this.fire("getCalendarSelectedService");
                this.fire("getDroppointSelectedService");
            },          

            updateDeliveryOptions: function (e) {
                if (e.target.checked) {
                    if (e.target.id !== "-3") {
                        var method = this._getDeliveryRateById(e.target.id);
                        this.selectedServiceDetails.serviceId = method.id;
                        this.selectedServiceDetails.service = method.methodTitle;
                        this.selectedServiceDetails.serviceCode = method.carrierCode;
                        this.selectedServiceDetails.carrier = method.carrierName;
                        this.selectedServiceDetails.shipping = method.price;
                        this.selectedServiceDetails.expDeliveryDateStart = moment(method.deliveryTimeFrom).toISOString();
                        this.selectedServiceDetails.expDeliveryDateEnd = moment(method.deliveryTimeTo).add(method.maxDD - method.minDD, 'days').toISOString();
                        this.selectedServiceDetails.currencySymbol = this.currencySymbol;

                        if (this.$.dropPointDeliveriesOption.checked == true) {
                            this.selectedServiceDetails.collectionPoint = this._selectedDropPoint.droppointId;
                            this.selectedServiceDetails.deliveryAddress = this._selectedDropPoint.geoLocation;
                            this.closeCheckout.selectedDroppointId = this._selectedDropPoint.droppointId;
                        }
                        else {
                            this.closeCheckout.selectedDroppointId = null;
                        }

                        this.fire('selectedServiceChanged', this.selectedServiceDetails);

                        if (this.$.standardDeliveriesOption.checked === true) {
                            this.fire("getStandardSelectedService", this.selectedServiceDetails);
                        }

                        if (this.$.calendarDeliveriesOption.checked === true) {
                            this.fire("getCalendarSelectedService", this.selectedServiceDetails);
                        }

                        if (this.$.dropPointDeliveriesOption.checked === true) {
                            this.fire("getDroppointSelectedService", this.selectedServiceDetails);
                        }

                        this.closeCheckout.selectedDeliveryOptionID = method.deliveryOptionId;                        
                    }

                    var checkoutResultsData = document.getElementById(this.checkoutResults);
                    if (!!checkoutResultsData) {
                        checkoutResultsData.value = btoa(JSON.stringify(this.closeCheckout));
                    }
                    var sessionID = document.getElementById(this.sessionid);
                    if (!!sessionID) {
                        sessionID.value = btoa(this._sessionId);
                    }
                }
            },

            _noServices: function(e) {
                // Check if the default-* values are defined
                if (this.defaultService != "" || this.defaultCarrier != "" || this.defaultMinDeliveryTime != "" || this.defaultMaxDeliveryTime != "" || this.defaultPrice != "") {
                    // create an array for polymer
                    this.standardRates = [];
                    var today = new Date();
                    var startDate = new Date(today);
                    startDate.setDate(startDate.getDate() + parseInt(this.defaultMinDeliveryTime));
                    var endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (this.defaultMaxDeliveryTime - 1));

                    this.standardRates = [{
                        id: -3,
                        methodTitle: this.defaultService,
                        price: this.defaultPrice,
                        deliveryDateRange: this._formatNonDayDefiniteDate(startDate, endDate),
                        selected: true,
                        carrier: this.defaultCarrier
                    }];

                    var method = this.standardRates.shift();
                    this.selectedServiceDetails.serviceId = method.id;
                    this.selectedServiceDetails.service = this.defaultService;
                    this.selectedServiceDetails.serviceCode = this.defaultCarrierCode;
                    this.selectedServiceDetails.carrier = this.defaultCarrier;
                    this.selectedServiceDetails.shipping = this.defaultPrice;
                    this.selectedServiceDetails.expDeliveryDateStart = startDate;
                    this.selectedServiceDetails.expDeliveryDateEnd = endDate;
                    this.selectedServiceDetails.deliveryAddress = actualPost.Request.Order.Transit.Recipient.Location;

                    this.fire('selectedServiceChanged', this.selectedServiceDetails);

                    if (this.$.standardDeliveriesOption.checked === true) {
                        this.fire("getStandardSelectedService", this.selectedServiceDetails);
                    }
                }
                else {
                    this.standardRates = [];
                    this.$.errorNotification.text = "The default service has not been configured, please contact website support";
                    this.$.errorNotification.duration = 8000;
                    this.$.errorNotification.open();
                }  
            }
        });

    </script>
</dom-module>
